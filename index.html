<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Provi Portal</title>
  <style>
    :root{--bg:#0b0f14;--card:#121a24;--line:#223043;--text:#e7f0fb;--muted:#8aa0b8;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#0b0f14,#070a0d);color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:18px;}
    .card{background:rgba(18,26,36,.92);border:1px solid var(--line);border-radius:16px;padding:16px;}
    h1{margin:0;font-size:18px;}
    .muted{color:var(--muted);font-size:12px;margin-top:6px;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px;}
    .spacer{flex:1}
    .btn{border:1px solid var(--line);background:var(--card);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:800;}
    .btn.primary{background:linear-gradient(180deg,#1d3b63,#162a44);border-color:#2f5f9a}
    .btn.danger{background:linear-gradient(180deg,#5a1d1d,#3b1414);border-color:#8a2f2f}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    a.link{color:#cfe3ff;text-decoration:none;border:1px solid var(--line);padding:10px 12px;border-radius:12px;display:inline-block}
    input,select{background:#0e1520;border:1px solid var(--line);color:var(--text);padding:10px 10px;border-radius:12px;outline:none;min-width:180px}
    pre{white-space:pre-wrap;word-break:break-word;background:#0e1520;border:1px solid var(--line);padding:10px;border-radius:12px;color:#cfe3ff;font-size:12px;margin-top:10px;}
    .pill{font-size:12px;border:1px solid var(--line);padding:4px 8px;border-radius:999px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Provisioning Web Portal</h1>
      <div class="muted">2 Users (local login) + Sync ไป Google Drive (Apps Script) ทุก 60 นาทีเมื่อมีการเปลี่ยนแปลง</div>

      <div class="row">
        <a class="link" href="provi-daily-checklist.html">Provi Daily Checklist</a>
        <a class="link" href="temp_configuration.html">Temp Configuration</a>
        <div class="spacer"></div>
        <span class="pill" id="dirtyPill">dirty: no</span>
      </div>

      <div class="row" style="margin-top:14px;">
        <select id="userPick" title="เลือกผู้ใช้">
          <option value="">เลือกผู้ใช้…</option>
          <option value="Patcharapong">Patcharapong</option>
          <option value="Nawaphon">Nawaphon</option>
        </select>
        <input id="pass" placeholder="password" type="password" />
        <button class="btn primary" id="btnLogin">Login</button>
        <button class="btn" id="btnLogout">Logout</button>
        <div class="spacer"></div>
        <div class="muted" id="who">Not logged in</div>
      </div>

      <div class="row">
        <button class="btn primary" id="btnSync">Sync now</button>
        <button class="btn" id="btnMarkDirty">Mark dirty</button>
        <button class="btn danger" id="btnForceSync">Force sync</button>
        <button class="btn" id="btnOpenFile">Open Drive folder</button>
        <div class="spacer"></div>
        <div class="muted" id="status">Ready</div>
      </div>

      <div class="muted" style="margin-top:12px;">ดีบัก</div>
      <pre id="out">-</pre>
    </div>
  </div>

  <script>
    /** =========================
     * CONFIG
     * ========================= **/
    const API_URL = "https://script.google.com/macros/s/AKfycbwBHkVJ6TWyG0-pefvL1alAlB5RZVsix_g7kdM4TfGp_qiyKLll7lof5iZZfjASBy3pvg/exec";
    const ROOT_DRIVE_FOLDER_ID = "1sxBCtzxb7J_Hkw_9o_klPkQHHXLyMtIk"; // ProviPortal folder
    const AUTO_SYNC_MINUTES = 60;

    const DIRTY_KEY = "provi_dirty";
    const SESSION_KEY = "provi_session"; // {user,pass,ymLastSync}

    const $ = (id) => document.getElementById(id);
    const setStatus = (t) => $("status").textContent = t;
    const log = (obj) => $("out").textContent = (typeof obj === "string") ? obj : JSON.stringify(obj, null, 2);

    function ymNow(){ return new Date().toISOString().slice(0,7); }

    function isDirty(){ return localStorage.getItem(DIRTY_KEY) === "1"; }
    function setDirty(v){
      if(v) localStorage.setItem(DIRTY_KEY,"1");
      else localStorage.removeItem(DIRTY_KEY);
      $("dirtyPill").textContent = "dirty: " + (isDirty() ? "YES" : "no");
      $("dirtyPill").style.color = isDirty() ? "#ffd089" : "var(--muted)";
    }

    function getSession(){
      try { return JSON.parse(localStorage.getItem(SESSION_KEY) || "{}"); }
      catch { return {}; }
    }
    function setSession(s){ localStorage.setItem(SESSION_KEY, JSON.stringify(s)); }
    function clearSession(){ localStorage.removeItem(SESSION_KEY); }

    function refreshWho(){
      const s = getSession();
      $("who").textContent = s.user ? `Logged in: ${s.user}` : "Not logged in";
    }

    function buildPayload(){
      const s = getSession();
      const actor = s.user || "unknown";

      // dummy payload (เพื่อเช็ค sync)
      const now = new Date();
      const dd = now.toISOString().slice(0,10);
      const tt = now.toTimeString().slice(0,5);

      return {
        actor,
        logs: [[dd, tt, actor, "SOF-TEST", "C-TEST", "DIA", "SYNC_TEST", "from portal", "ok", ""]],
        circuits: [[`${actor} TEST CIRCUIT`, "SOF-TEST", "C-TEST", "DIA", 5, `${dd} ${tt}`, "", "ทดลอง sync", "1. จอง SID"]],
        events: [],
        _source: "dummy"
      };
    }

    async function sendToScript({ force=false } = {}){
      const s = getSession();
      if(!s.user || !s.pass) throw new Error("NOT_LOGGED_IN");
      if(!force && !isDirty()) return { skipped:true, reason:"NOT_DIRTY" };

      const ym = ymNow();
      const payload = buildPayload();

      setStatus("Sending...");
      await fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body: new URLSearchParams({
          payload: JSON.stringify({ user: s.user, pass: s.pass, ym, data: payload })
        })
      });

      setStatus("✅ Sent (check Drive)");
      log({ ok:true, sent:true, ym, user:s.user, source: payload._source });

      setDirty(false);
      setSession({ ...s, ymLastSync: ym });
      return { ok:true };
    }

    function openDriveFolder(){
      window.open(`https://drive.google.com/drive/folders/${ROOT_DRIVE_FOLDER_ID}`, "_blank");
      setStatus("Opened Drive folder");
    }

    function startAutoSync(){
      setInterval(async () => {
        try{
          if(!isDirty()) return;
          await sendToScript({ force:false });
        }catch(e){
          console.error(e);
          setStatus("⚠ Auto-sync failed: " + (e.message || e));
        }
      }, AUTO_SYNC_MINUTES * 60 * 1000);
    }

    function init(){
      setDirty(isDirty());
      refreshWho();

      $("btnLogin").onclick = () => {
        const user = $("userPick").value;
        const pass = $("pass").value;
        if(!user || !pass){ setStatus("⚠ เลือก user + ใส่รหัส"); return; }
        setSession({ user, pass, ymLastSync: "" });
        $("pass").value = "";
        refreshWho();
        setStatus("✅ Logged in (local)");
        log({ ok:true, user });
      };

      $("btnLogout").onclick = () => {
        clearSession();
        refreshWho();
        setStatus("Logged out");
        log("logged out");
      };

      $("btnMarkDirty").onclick = () => { setDirty(true); setStatus("Marked dirty"); };

      $("btnSync").onclick = async () => {
        try { await sendToScript({ force:false }); }
        catch(e){ setStatus("❌ Sync failed: " + (e.message||e)); log(String(e)); }
      };

      $("btnForceSync").onclick = async () => {
        try { await sendToScript({ force:true }); }
        catch(e){ setStatus("❌ Force sync failed: " + (e.message||e)); log(String(e)); }
      };

      $("btnOpenFile").onclick = openDriveFolder;

      // ให้ checklist เรียกตอน save:
      // window.ProviPortal.markDirty();
      window.ProviPortal = {
        markDirty: () => setDirty(true),
        forceSync: () => sendToScript({ force:true }),
        getUser: () => (getSession().user || "")
      };

      startAutoSync();
      setStatus("Ready");
      log("Ready. Login แล้วกด Force sync เพื่อทดสอบ");
    }

    init();
  </script>
</body>
</html>
