<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Provi Portal ‚Äì Daily Checklist</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121a24; --muted:#9bb1c8; --text:#eaf2ff; --line:#243245;
      --accent:#ff8a2a; --accent2:#ffb36b; --good:#2ecc71; --bad:#ff4d6d; --warn:#f1c40f;
      --chip:#182434;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#0b0f14,#070a0d);color:var(--text);}
    a{color:inherit}
    header{position:sticky;top:0;z-index:20;background:rgba(11,15,20,.86);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);}
    .wrap{max-width:1500px;margin:0 auto;padding:14px;}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    .spacer{flex:1}
    h1{margin:0;font-size:16px;}
    .sub{color:var(--muted);font-size:12px;margin-top:4px;}
    .btn{border:1px solid var(--line);background:var(--card);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:800;}
    .btn:hover{border-color:#334a68}
    .btn.primary{background:linear-gradient(180deg,#3b2414,#2a180d);border-color:#7a461f}
    .btn.primary:hover{border-color:#b4622a}
    .btn.ghost{background:transparent}
    .btn.danger{background:linear-gradient(180deg,#5a1c2a,#3a101b);border-color:#a52b47}
    .btn[disabled]{opacity:.45;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--line);font-size:11px;color:#cfe3ff;white-space:nowrap;}
    .pill.good{border-color:#1c5a3a;color:#d1ffe6}
    .pill.bad{border-color:#6b1f2f;color:#ffd1dc}
    .pill.warn{border-color:#6b5a14;color:#ffeaa7}
    .card{background:rgba(18,26,36,.92);border:1px solid var(--line);border-radius:16px;padding:14px;}
    .muted{color:var(--muted);font-size:12px;}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{
      width:100%;background:#0e1520;border:1px solid var(--line);color:var(--text);
      padding:10px;border-radius:12px;outline:none;
    }
    textarea{min-height:70px;resize:vertical}
    .grid{display:grid;gap:12px;}
    @media(min-width:1100px){ .grid.app{grid-template-columns:420px 1fr;} }
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:#0e1520;color:var(--text);cursor:pointer;font-weight:900;font-size:12px;}
    .tab.active{border-color:#b4622a;background:rgba(255,138,42,.12)}
    table{width:100%;border-collapse:collapse;}
    th,td{border-bottom:1px solid var(--line);padding:8px;vertical-align:top;font-size:12px;}
    th{color:#ffd8b8;text-align:left;font-weight:900;background:rgba(40,24,14,.55);position:sticky;top:0;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;}
    .item{background:#0e1520;border:1px solid var(--line);border-radius:14px;padding:10px;cursor:pointer;}
    .item:hover{border-color:#b4622a}
    .item.active{border-color:#ff8a2a;box-shadow:0 0 0 2px rgba(255,138,42,.12) inset;}
    .item .title{font-weight:900;font-size:13px;margin-bottom:6px;}
    .item .meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:11px;}
    .bar{height:8px;background:#0b0f14;border:1px solid var(--line);border-radius:999px;overflow:hidden;}
    .bar > div{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%;}
    .step{display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid var(--line);border-radius:14px;background:#0e1520;margin-top:8px;}
    .step input[type="checkbox"]{width:18px;height:18px;margin-top:2px;}
    .step .name{font-weight:900;font-size:12px;}
    .toast{position:fixed;right:16px;bottom:16px;background:#0e1520;border:1px solid var(--line);padding:10px 12px;border-radius:12px;display:none;z-index:80;}
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .kpi .box{flex:1;min-width:160px;background:#0e1520;border:1px solid var(--line);border-radius:14px;padding:10px;}
    .box .n{font-size:18px;font-weight:900;}
    .box .t{font-size:11px;color:var(--muted);}
    .divider{height:1px;background:var(--line);margin:12px 0;}
    .rightTop{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .small{font-size:11px}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row">
      <div>
        <h1>Provi Portal ‚Äì Daily Checklist</h1>
        <div class="sub">‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á + ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‚Ä¢ Sync ‡πÑ‡∏õ Google Sheet ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Ä¢ ‡πÄ‡∏™‡∏£‡πá‡∏à = ‡∏ï‡∏¥‡πä‡∏Å Step 21</div>
      </div>
      <div class="spacer"></div>

      <span class="pill" id="pillUser">user: -</span>
      <span class="pill" id="pillYM">ym: -</span>
      <span class="pill" id="pillSync">sync: -</span>

      <button class="btn" id="btnSyncNow">Sync now</button>
      <button class="btn ghost" id="btnLogout">Logout</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- LOGIN PANEL -->
  <div id="loginPanel" class="card" style="max-width:560px;margin:18px auto;display:none;">
    <h2 style="margin:0 0 6px 0;font-size:14px;">Login</h2>
    <div class="muted">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ Sync ‡πÄ‡∏Ç‡πâ‡∏≤ Google Sheet</div>

    <label>Username</label>
    <input id="loginUser" placeholder="Patcharapong / Nawaphon" />

    <label>Password</label>
    <input id="loginPass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" />

    <label>Apps Script Web App URL</label>
    <input id="loginApi" placeholder="‡πÉ‡∏™‡πà URL .../exec" />

    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="btnLogin">Login</button>
      <div class="spacer"></div>
      <span class="muted small">* URL ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</span>
    </div>
  </div>

  <!-- APP -->
  <div id="appPanel" style="display:none;">
    <div class="grid app">
      <!-- LEFT -->
      <aside class="card">
        <div class="row">
          <h2 style="margin:0;font-size:14px;">Circuits (Active)</h2>
          <div class="spacer"></div>
          <button class="btn primary" id="btnToggleAdd">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏á‡∏à‡∏£</button>
        </div>

        <div class="kpi" id="kpi"></div>

        <div id="addPanel" class="card" style="display:none;background:#0e1520;border-color:var(--line);margin-top:10px;">
          <div class="row">
            <div style="font-weight:900;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏á‡∏à‡∏£‡πÉ‡∏´‡∏°‡πà</div>
            <div class="spacer"></div>
            <span class="muted small">Type auto ‡∏à‡∏≤‡∏Å CID (C=DIA / P=DPLC)</span>
          </div>

          <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr 1.2fr 1fr auto;margin-top:10px;">
            <div><label style="margin-top:0;">SOF</label><input id="addSof" placeholder="SOF" /></div>
            <div><label style="margin-top:0;">CID</label><input id="addCid" placeholder="C... ‡∏´‡∏£‡∏∑‡∏≠ P..." /></div>
            <div><label style="margin-top:0;">‡∏ä‡∏∑‡πà‡∏≠</label><input id="addName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô" /></div>
            <div><label style="margin-top:0;">M (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input id="addM" placeholder="‡πÄ‡∏ä‡πà‡∏ô M123 ‡∏´‡∏£‡∏∑‡∏≠ M123,M124" /></div>
            <div style="display:flex;align-items:flex-end;">
              <button class="btn primary" id="btnAddCircuit" style="width:120px;">Add</button>
            </div>
          </div>
          <div class="muted small" id="addHint" style="margin-top:10px;"></div>
        </div>

        <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
        <input id="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ SOF / CID / ‡∏ä‡∏∑‡πà‡∏≠ / M" />

        <div class="row">
          <div style="flex:1;min-width:180px;">
            <label>‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
            <select id="filterType">
              <option value="ALL">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="DIA">DIA (CID ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô C)</option>
              <option value="DPLC">DPLC (CID ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô P)</option>
            </select>
          </div>
          <div style="flex:1;min-width:180px;">
            <label>‡πÄ‡∏£‡∏µ‡∏¢‡∏á</label>
            <select id="sortMode">
              <option value="lastUpdate">Last update ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
              <option value="percent">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏°‡∏≤‡∏Å‚Üí‡∏ô‡πâ‡∏≠‡∏¢</option>
              <option value="name">‡∏ä‡∏∑‡πà‡∏≠ A‚ÜíZ</option>
              <option value="created">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‚Üí‡∏´‡∏•‡∏±‡∏á</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>
        <div id="circuitList" style="display:flex;flex-direction:column;gap:10px;"></div>
      </aside>

      <!-- RIGHT -->
      <section class="card">
        <div class="rightTop">
          <h2 id="rightTitle" style="margin:0;font-size:14px;">Dashboard</h2>
          <div class="spacer"></div>
          <button class="btn" id="btnGoDashboard">Dashboard</button>
          <button class="btn" id="btnGoDetail">Circuit Detail</button>
          <button class="btn" id="btnGoEvents">Events</button>
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="dashboard">Dashboard</button>
          <button class="tab" data-tab="detail">Circuit Detail</button>
          <button class="tab" data-tab="events">Events</button>
        </div>

        <!-- Dashboard -->
        <div id="tab-dashboard" style="margin-top:10px;">
          <div class="row">
            <span class="pill good" id="pillMonthInfo"></span>
            <div class="spacer"></div>
            <span class="muted small">Auto-sync ‡∏ó‡∏∏‡∏Å 60 ‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á)</span>
          </div>

          <div style="margin-top:12px;">
            <label>Log ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</label>
            <div style="max-height:420px;overflow:auto;border:1px solid var(--line);border-radius:14px;">
              <table>
                <thead>
                  <tr>
                    <th>doneAt</th><th>CID</th><th>Action</th><th>Step</th><th>Detail</th>
                  </tr>
                </thead>
                <tbody id="logTable"></tbody>
              </table>
            </div>
          </div>

          <div style="margin-top:12px;">
            <label>Work Status (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</label>
            <div style="max-height:420px;overflow:auto;border:1px solid var(--line);border-radius:14px;">
              <table>
                <thead>
                  <tr>
                    <th>CID</th><th>%</th><th>Next</th><th>Install</th><th>Remark</th><th>Last</th>
                  </tr>
                </thead>
                <tbody id="wsTable"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Detail -->
        <div id="tab-detail" style="display:none;margin-top:10px;">
          <div id="noSelected" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏á‡∏à‡∏£ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å list ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢)</div>

          <div id="detailPanel" style="display:none;">
            <div class="row">
              <span class="pill">Type: <b id="dType">-</b></span>
              <span class="pill">Progress: <b id="dPct">0%</b></span>
              <span class="pill">Last: <span class="mono" id="dLast">-</span></span>
              <span class="pill">Install: <span class="mono" id="dInstall">-</span></span>
              <div class="spacer"></div>
              <button class="btn danger" id="btnArchiveDone">Archive (‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)</button>
            </div>

            <div style="margin-top:10px;" class="bar"><div id="dBar"></div></div>

            <div class="divider"></div>

            <div class="row">
              <button class="btn" id="btnToggleMeta">‚úèÔ∏è ‡πÅ‡∏Å‡πâ SOF/CID/‡∏ä‡∏∑‡πà‡∏≠/M</button>
              <div class="spacer"></div>
              <button class="btn" id="btnToggleInstall">üìå ‡∏ï‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</button>
            </div>

            <div id="metaPanel" class="card" style="display:none;background:#0e1520;border-color:var(--line);margin-top:10px;">
              <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr 1.2fr 1fr;">
                <div><label>SOF</label><input id="editSof" /></div>
                <div><label>CID</label><input id="editCid" /></div>
                <div><label>‡∏ä‡∏∑‡πà‡∏≠</label><input id="editName" /></div>
                <div><label>M</label><input id="editM" /></div>
              </div>
              <div class="row" style="margin-top:10px;">
                <button class="btn primary" id="btnSaveMeta">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <div class="spacer"></div>
                <button class="btn" id="btnCloseMeta">Close</button>
              </div>
            </div>

            <div id="installPanel" class="card" style="display:none;background:#0e1520;border-color:var(--line);margin-top:10px;">
              <div style="display:grid;gap:10px;grid-template-columns:240px 1fr auto;">
                <div>
                  <label style="margin-top:0;">Install date</label>
                  <input type="date" id="installDate" />
                </div>
                <div>
                  <label style="margin-top:0;">Note (optional)</label>
                  <input id="installNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô onsite / ‡∏ô‡∏±‡∏î‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤" />
                </div>
                <div style="display:flex;align-items:flex-end;gap:10px;">
                  <button class="btn primary" id="btnSaveInstall">Save</button>
                  <button class="btn danger" id="btnClearInstall">Clear</button>
                </div>
              </div>
            </div>

            <label style="margin-top:12px;">Remark (‡∏ï‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£/‡∏£‡∏≠‡πÉ‡∏Ñ‡∏£)</label>
            <textarea id="remark" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠ IP / ‡∏£‡∏≠ WHA / ‡∏£‡∏≠‡∏Ç‡∏≠‡∏á"></textarea>
            <div class="row" style="margin-top:10px;">
              <button class="btn primary" id="btnSaveRemark">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Remark</button>
              <div class="spacer"></div>
              <span class="muted small">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏•‡∏á log ‡∏û‡∏£‡πâ‡∏≠‡∏° doneAt</span>
            </div>

            <div style="margin-top:14px;">
              <h3 style="margin:0 0 6px 0;font-size:13px;">Checklist (21 ‡∏Ç‡∏±‡πâ‡∏ô)</h3>
              <div class="muted small">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ ‚Äú‡∏ï‡∏¥‡πä‡∏Å Step 21 (‡∏õ‡∏¥‡∏î CR)‚Äù</div>
              <div id="steps"></div>
            </div>
          </div>
        </div>

        <!-- Events -->
        <div id="tab-events" style="display:none;margin-top:10px;">
          <div class="row">
            <div style="flex:1;min-width:240px;">
              <label>Date</label>
              <input type="date" id="evDate" />
            </div>
            <div style="flex:1;min-width:240px;">
              <label>Slot</label>
              <select id="evSlot">
                <option value="AM">‡πÄ‡∏ä‡πâ‡∏≤ (AM)</option>
                <option value="PM">‡∏ö‡πà‡∏≤‡∏¢ (PM)</option>
                <option value="ALL">‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô (ALL)</option>
              </select>
            </div>
          </div>
          <label>Title</label>
          <input id="evTitle" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏≤ / ‡∏≠‡∏ö‡∏£‡∏° / ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô" />
          <label>Note (optional)</label>
          <input id="evNote" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" />
          <div class="row" style="margin-top:10px;">
            <button class="btn primary" id="btnAddEvent">Add event</button>
            <div class="spacer"></div>
            <span class="muted small">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ä‡∏µ‡∏ó Events ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
          </div>

          <div style="margin-top:12px;">
            <label>Events ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</label>
            <div style="max-height:520px;overflow:auto;border:1px solid var(--line);border-radius:14px;">
              <table>
                <thead><tr><th>Date</th><th>Slot</th><th>Title</th><th>Note</th><th>Del</th></tr></thead>
                <tbody id="evTable"></tbody>
              </table>
            </div>
          </div>
        </div>

      </section>
    </div>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
/** ======================
 * CONFIG
 * ======================= */
// ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Apps Script Web App (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ /exec)
let APPS_SCRIPT_URL = localStorage.getItem("provi_api_url") || ""; // set from login

// storage keys
const SESSION_KEY = "provi_session";           // {user, pass}
const ACTIVE_KEY  = "provi_active";            // {circuits: {id: circuit}}
const ACTIVE_MONTH_KEY = "provi_activeMonth";  // "YYYY-MM"
const MONTHLY_PREFIX = "provi_monthly_";       // + YYYY-MM => {logs:[], events:[], workStatus:[], dirty:true, lastHash, lastSyncAt}

const STEPS = [
  "‡∏à‡∏≠‡∏á SID","‡∏™‡∏£‡πâ‡∏≤‡∏á SID ‡∏ö‡∏ô CMDB","‡∏™‡∏£‡πâ‡∏≤‡∏á Folder ‡πÑ‡∏î‡∏ü‡πå‡∏Å‡∏•‡∏≤‡∏á","‡πÄ‡∏õ‡∏¥‡∏î Task ‡πÑ‡∏õ‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á",
  "‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô/‡∏™‡∏£‡∏∏‡∏õ requirement ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö","‡πÄ‡∏ä‡πá‡∏Ñ stock / ‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á","‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° config ‡∏ï‡∏≤‡∏°‡∏ß‡∏á‡∏à‡∏£","‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°",
  "‡∏ó‡∏≥ 147","‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å Node","Shape Bandwidth","Add Zabbix + SMS Alert (‡∏ñ‡πâ‡∏≤ SOF ‡∏£‡∏∞‡∏ö‡∏∏)","Add Graph",
  "‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏ú‡∏ô‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á + ‡∏ô‡∏±‡∏î‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå","‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤","‡∏õ‡∏¥‡∏î SR","Update Inventory",
  "Update CMDB","Update CMDB (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°/‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà 2)","‡∏ó‡∏≥ F-108","‡∏õ‡∏¥‡∏î CR"
];
const STEP_DONE_IDX = 20; // Step 21 (0-based)

/** ======================
 * HELPERS
 * ======================= */
const $ = (id)=>document.getElementById(id);

function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.style.display="none",1600);
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

function uid(prefix="X"){
  return prefix + Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function ymNow(){
  const d=new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}

function isoDate(d){
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function todayStr(){ return isoDate(new Date()); }

function nowTime(){
  const d=new Date();
  const hh=String(d.getHours()).padStart(2,"0");
  const mi=String(d.getMinutes()).padStart(2,"0");
  const ss=String(d.getSeconds()).padStart(2,"0");
  return `${hh}:${mi}:${ss}`;
}
function doneAtStr(){
  // yyyy-mm-dd hh:mm:ss (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà Apps Script ‡πÉ‡∏ä‡πâ format)
  return `${todayStr()} ${nowTime()}`;
}

function loadJSON(key, fallback){
  try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }
  catch{ return fallback; }
}
function saveJSON(key, val){
  localStorage.setItem(key, JSON.stringify(val));
}

function inferTypeFromCID(cid){
  const c=(cid||"").trim().toUpperCase();
  if(c.startsWith("C")) return "DIA";
  if(c.startsWith("P")) return "DPLC";
  return "INVALID";
}

function isStepDone(c, idx){
  return !!(c.stepsDone && c.stepsDone[idx] && c.stepsDone[idx].done);
}
function percentOf(c){
  const doneCount = STEPS.reduce((a,_,i)=>a+(isStepDone(c,i)?1:0),0);
  return Math.round((doneCount/STEPS.length)*100);
}
function nextStepIndex(c){
  for(let i=0;i<STEPS.length;i++) if(!isStepDone(c,i)) return i;
  return null;
}
function isCompleted(c){
  return isStepDone(c, STEP_DONE_IDX) || percentOf(c) === 100;
}
function lastUpdateStamp(c){
  return `${c.lastUpdateDate||"-"} ${c.lastUpdateTime||"-"}`;
}
function touchUpdate(c){
  c.lastUpdateDate = todayStr();
  c.lastUpdateTime = nowTime();
}

/** ======================
 * STATE
 * ======================= */
let session = loadJSON(SESSION_KEY, null); // {user, pass}
let active  = loadJSON(ACTIVE_KEY, {circuits:{}});
let currentYM = ymNow();

function getMonthlyKey(ym){ return MONTHLY_PREFIX + ym; }
function getMonthly(ym){
  return loadJSON(getMonthlyKey(ym), { logs:[], events:[], workStatus:[], dirty:false, lastHash:"", lastSyncAt:"" });
}
function setMonthly(ym, obj){
  saveJSON(getMonthlyKey(ym), obj);
}

function ensureActiveMonth(){
  const saved = localStorage.getItem(ACTIVE_MONTH_KEY);
  if(!saved){
    localStorage.setItem(ACTIVE_MONTH_KEY, currentYM);
  }
}

function updateHeaderPills(){
  $("pillUser").textContent = `user: ${session?.user || "-"}`;
  $("pillYM").textContent = `ym: ${currentYM}`;
  const m = getMonthly(currentYM);
  $("pillSync").textContent = m.lastSyncAt ? `sync: ${m.lastSyncAt}` : `sync: -`;
  $("pillMonthInfo").textContent = `‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: ${currentYM} ‚Ä¢ logs ${m.logs.length} ‚Ä¢ events ${m.events.length} ‚Ä¢ work ${m.workStatus.length}`;
}

/** ======================
 * LOGIN / LOGOUT
 * ======================= */
function showLogin(){
  $("loginPanel").style.display = "";
  $("appPanel").style.display = "none";
  $("loginApi").value = APPS_SCRIPT_URL || "";
}
function showApp(){
  $("loginPanel").style.display = "none";
  $("appPanel").style.display = "";
}

$("btnLogin").addEventListener("click", async ()=>{
  const user = ($("loginUser").value||"").trim();
  const pass = ($("loginPass").value||"").trim();
  const api  = ($("loginApi").value||"").trim();
  if(!user || !pass || !api){ toast("‡∏Å‡∏£‡∏≠‡∏Å user/pass ‡πÅ‡∏•‡∏∞ URL ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); return; }

  APPS_SCRIPT_URL = api;
  localStorage.setItem("provi_api_url", api);

  session = {user, pass};
  saveJSON(SESSION_KEY, session);

  // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏¢‡∏¥‡∏á doGet
  try{
    const r = await fetch(api, {method:"GET"});
    if(!r.ok) throw new Error("API_NOT_OK");
  }catch(e){
    toast("URL API ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ/‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
    return;
  }

  ensureActiveMonth();
  showApp();
  renderAll();
  toast("Login ‡πÅ‡∏•‡πâ‡∏ß");
});

$("btnLogout").addEventListener("click", ()=>{
  localStorage.removeItem(SESSION_KEY);
  session = null;
  toast("Logout ‡πÅ‡∏•‡πâ‡∏ß");
  showLogin();
});

/** ======================
 * ROLLOVER (NEW MONTH) - after successful sync
 * ======================= */
function rolloverToNewMonth(newYM){
  // keep only incomplete circuits
  const remain = {};
  for(const id of Object.keys(active.circuits || {})){
    const c = active.circuits[id];
    if(!isCompleted(c)) remain[id] = c;
  }
  active = {circuits: remain};
  saveJSON(ACTIVE_KEY, active);

  // clear ALL monthly caches (logs/events/work) - because already in Sheets
  Object.keys(localStorage).forEach(k=>{
    if(k.startsWith(MONTHLY_PREFIX)) localStorage.removeItem(k);
  });

  localStorage.setItem(ACTIVE_MONTH_KEY, newYM);
}

/** ======================
 * LOG / EVENT / WORK STATUS (MONTHLY)
 * ======================= */
function addMonthlyLog(row){
  // row object => normalized later for API
  const m = getMonthly(currentYM);
  m.logs.push(row);
  m.dirty = true;
  setMonthly(currentYM, m);
}

function addMonthlyEvent(ev){
  const m = getMonthly(currentYM);
  m.events.push(ev);
  m.dirty = true;
  setMonthly(currentYM, m);
}

function removeMonthlyEvent(eventId){
  const m = getMonthly(currentYM);
  const idx = m.events.findIndex(x=>x.eventId===eventId);
  if(idx>=0){
    m.events.splice(idx,1);
    m.dirty = true;
    setMonthly(currentYM, m);
  }
}

function rebuildWorkStatus(){
  // Work_Status ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ = snapshot ‡∏Ç‡∏≠‡∏á active circuits + (‡∏ñ‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡πá‡∏¢‡∏±‡∏á‡πÇ‡∏ä‡∏ß‡πå‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÄ‡∏£‡∏≤‡∏Ñ‡∏∑‡∏≠ active ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
  const rows = Object.values(active.circuits || {}).map(c=>{
    const pct = percentOf(c);
    const nxt = nextStepIndex(c);
    return {
      ym: currentYM,
      user: session.user,
      cid: c.cid,
      type: c.type,
      sof: c.sof,
      name: c.name,
      progressPercent: pct,
      lastUpdateAt: `${c.lastUpdateDate||todayStr()} ${c.lastUpdateTime||nowTime()}`,
      nextStepNo: (nxt===null? "" : (nxt+1)),
      nextStepName: (nxt===null? "DONE" : STEPS[nxt]),
      installDate: c.installDate || "",
      remark: (c.remark||"").trim(),
      m: (c.m||"").trim()
    };
  });

  const m = getMonthly(currentYM);
  m.workStatus = rows;
  m.dirty = true;
  setMonthly(currentYM, m);
}

/** ======================
 * UI NAV
 * ======================= */
const tabs = [...document.querySelectorAll(".tab[data-tab]")];
function switchTab(name){
  tabs.forEach(b=>b.classList.toggle("active", b.dataset.tab===name));
  $("tab-dashboard").style.display = name==="dashboard" ? "" : "none";
  $("tab-detail").style.display    = name==="detail" ? "" : "none";
  $("tab-events").style.display    = name==="events" ? "" : "none";
  $("rightTitle").textContent = name==="dashboard" ? "Dashboard" : name==="detail" ? "Circuit Detail" : "Events";
  renderAll();
}
tabs.forEach(b=>b.addEventListener("click", ()=>switchTab(b.dataset.tab)));
$("btnGoDashboard").addEventListener("click", ()=>switchTab("dashboard"));
$("btnGoDetail").addEventListener("click", ()=>switchTab("detail"));
$("btnGoEvents").addEventListener("click", ()=>switchTab("events"));

/** ======================
 * CIRCUIT CRUD
 * ======================= */
let selectedId = null;

$("btnToggleAdd").addEventListener("click", ()=>{
  const p=$("addPanel");
  p.style.display = (p.style.display==="none") ? "" : "none";
});

$("addCid").addEventListener("input", ()=>{
  const t=inferTypeFromCID($("addCid").value);
  $("addHint").textContent = (t==="INVALID") ? "CID ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô C ‡∏´‡∏£‡∏∑‡∏≠ P" : `Type (auto): ${t}`;
});

$("btnAddCircuit").addEventListener("click", ()=>{
  const sof=($("addSof").value||"").trim();
  const cid=($("addCid").value||"").trim();
  const name=($("addName").value||"").trim();
  const m=($("addM").value||"").trim();
  if(!sof||!cid||!name){ toast("‡∏Å‡∏£‡∏≠‡∏Å SOF, CID, ‡∏ä‡∏∑‡πà‡∏≠ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); return; }
  const type=inferTypeFromCID(cid);
  if(type==="INVALID"){ toast("CID ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô C ‡∏´‡∏£‡∏∑‡∏≠ P"); return; }

  const id=uid("C");
  const c={
    id, sof, cid, name, type, m,
    createdAt: todayStr(),
    lastUpdateDate: todayStr(),
    lastUpdateTime: nowTime(),
    remark:"",
    installDate:"",
    installNote:"",
    stepsDone:{}
  };
  active.circuits[id]=c;
  saveJSON(ACTIVE_KEY, active);
  selectedId = id;

  addMonthlyLog(makeLog("CIRCUIT_CREATE", c, {detail:"‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏á‡∏à‡∏£‡πÉ‡∏´‡∏°‡πà"}));
  rebuildWorkStatus();

  $("addSof").value=""; $("addCid").value=""; $("addName").value=""; $("addM").value="";
  $("addPanel").style.display="none";
  toast("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏á‡∏à‡∏£‡πÅ‡∏•‡πâ‡∏ß");
  switchTab("detail");
});

$("search").addEventListener("input", renderCircuitList);
$("filterType").addEventListener("change", renderCircuitList);
$("sortMode").addEventListener("change", renderCircuitList);

function makeLog(action, c, extra={}){
  const nxt = nextStepIndex(c);
  return {
    ym: currentYM,
    doneAt: doneAtStr(),
    user: session.user,
    sof: c?.sof || "",
    cid: c?.cid || "",
    type: c?.type || "",
    action,
    stepNo: extra.stepNo ?? "",
    stepName: extra.stepName ?? "",
    detail: extra.detail ?? "",
    remarkSnapshot: (c?.remark || "").trim(),
    mSnapshot: (c?.m || "").trim(),
    blockerTag: extra.blockerTag ?? "",
    logId: extra.logId ?? uid("L")
  };
}

/** ======================
 * DETAIL ACTIONS
 * ======================= */
$("btnToggleMeta").addEventListener("click", ()=>{
  const p=$("metaPanel");
  p.style.display = (p.style.display==="none") ? "" : "none";
});
$("btnCloseMeta").addEventListener("click", ()=> $("metaPanel").style.display="none");

$("btnSaveMeta").addEventListener("click", ()=>{
  const c=getSelected();
  if(!c) return;
  const sof=($("editSof").value||"").trim();
  const cid=($("editCid").value||"").trim();
  const name=($("editName").value||"").trim();
  const m=($("editM").value||"").trim();
  if(!sof||!cid||!name){ toast("‡∏Å‡∏£‡∏≠‡∏Å SOF, CID, ‡∏ä‡∏∑‡πà‡∏≠ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); return; }
  const type=inferTypeFromCID(cid);
  if(type==="INVALID"){ toast("CID ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô C ‡∏´‡∏£‡∏∑‡∏≠ P"); return; }

  c.sof=sof; c.cid=cid; c.name=name; c.type=type; c.m=m;
  touchUpdate(c);
  saveJSON(ACTIVE_KEY, active);

  addMonthlyLog(makeLog("CIRCUIT_EDIT", c, {detail:"‡πÅ‡∏Å‡πâ SOF/CID/‡∏ä‡∏∑‡πà‡∏≠/M"}));
  rebuildWorkStatus();

  $("metaPanel").style.display="none";
  toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
  renderAll();
});

$("btnToggleInstall").addEventListener("click", ()=>{
  const p=$("installPanel");
  p.style.display = (p.style.display==="none") ? "" : "none";
});

$("btnSaveInstall").addEventListener("click", ()=>{
  const c=getSelected(); if(!c) return;
  c.installDate = $("installDate").value || "";
  c.installNote = ($("installNote").value||"").trim();
  touchUpdate(c);
  saveJSON(ACTIVE_KEY, active);

  addMonthlyLog(makeLog("INSTALL_SET", c, {detail:`install=${c.installDate}${c.installNote?` (${c.installNote})`:``}`}));
  rebuildWorkStatus();

  $("installPanel").style.display="none";
  toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
  renderAll();
});

$("btnClearInstall").addEventListener("click", ()=>{
  const c=getSelected(); if(!c) return;
  const prev = c.installDate || "";
  c.installDate=""; c.installNote="";
  touchUpdate(c);
  saveJSON(ACTIVE_KEY, active);

  addMonthlyLog(makeLog("INSTALL_CLEAR", c, {detail:`‡∏•‡∏ö install ‡πÄ‡∏î‡∏¥‡∏°=${prev}`}));
  rebuildWorkStatus();

  $("installPanel").style.display="none";
  toast("‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
  renderAll();
});

$("btnSaveRemark").addEventListener("click", ()=>{
  const c=getSelected(); if(!c) return;
  c.remark = ($("remark").value||"").trim();
  touchUpdate(c);
  saveJSON(ACTIVE_KEY, active);

  addMonthlyLog(makeLog("REMARK_UPDATE", c, {detail:"‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï remark"}));
  rebuildWorkStatus();

  toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
  renderAll();
});

$("btnArchiveDone").addEventListener("click", ()=>{
  const c=getSelected(); if(!c) return;

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡πä‡∏Å step 21 ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô
  if(!isStepDone(c, STEP_DONE_IDX)){
    const ok = confirm("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏¥‡πä‡∏Å Step 21 (‡∏õ‡∏¥‡∏î CR) ‚Äî ‡∏à‡∏∞ Archive ‡πÄ‡∏•‡∏¢‡πÑ‡∏´‡∏°?");
    if(!ok) return;
  }

  // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å active (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)
  delete active.circuits[c.id];
  saveJSON(ACTIVE_KEY, active);

  addMonthlyLog(makeLog("CIRCUIT_ARCHIVE", c, {detail:"‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Active"}));
  rebuildWorkStatus();

  selectedId=null;
  toast("Archive ‡πÅ‡∏•‡πâ‡∏ß (‡∏´‡∏≤‡∏¢‡∏à‡∏≤‡∏Å Active)");
  switchTab("dashboard");
});

/** ======================
 * STEPS
 * ======================= */
function toggleStep(c, idx, checked){
  if(!c.stepsDone) c.stepsDone = {};
  if(!c.stepsDone[idx]) c.stepsDone[idx] = {done:false, date:""};
  c.stepsDone[idx].done = checked;
  c.stepsDone[idx].date = checked ? todayStr() : "";

  touchUpdate(c);
  saveJSON(ACTIVE_KEY, active);

  const stepNo = idx+1;
  const stepName = STEPS[idx];
  const detail = `${stepNo}. ${stepName}`;

  addMonthlyLog(makeLog(checked ? "STEP_CHECK" : "STEP_UNCHECK", c, {
    stepNo, stepName, detail
  }));

  // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡πä‡∏Å Step 21 ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà auto archive ‚Äî ‡πÉ‡∏´‡πâ‡∏û‡∏µ‡πà‡∏Å‡∏î Archive ‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ)
  rebuildWorkStatus();

  toast(checked ? "‡∏ï‡∏¥‡πä‡∏Å‡πÅ‡∏•‡πâ‡∏ß" : "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏¥‡πä‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
  renderAll();
}

/** ======================
 * EVENTS
 * ======================= */
$("evDate").value = todayStr();

$("btnAddEvent").addEventListener("click", ()=>{
  const date = $("evDate").value || todayStr();
  const slot = $("evSlot").value;
  const title = ($("evTitle").value||"").trim();
  const note = ($("evNote").value||"").trim();
  if(!title){ toast("‡πÉ‡∏™‡πà Title"); return; }

  const ev = { ym: currentYM, date, user: session.user, slot, title, note, eventId: uid("E") };
  addMonthlyEvent(ev);

  // log ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠ trace
  addMonthlyLog({
    ym: currentYM,
    doneAt: doneAtStr(),
    user: session.user,
    sof:"", cid:"", type:"",
    action:"EVENT_ADD",
    stepNo:"", stepName:"",
    detail:`${date} ${slot} ${title}${note?` (${note})`:``}`,
    remarkSnapshot:"", mSnapshot:"",
    blockerTag:"",
    logId: uid("L")
  });

  $("evTitle").value=""; $("evNote").value="";
  toast("‡πÄ‡∏û‡∏¥‡πà‡∏° event ‡πÅ‡∏•‡πâ‡∏ß");
  renderAll();
});

function deleteEvent(eventId){
  const m = getMonthly(currentYM);
  const ev = m.events.find(x=>x.eventId===eventId);
  if(!ev) return;

  removeMonthlyEvent(eventId);

  addMonthlyLog({
    ym: currentYM,
    doneAt: doneAtStr(),
    user: session.user,
    sof:"", cid:"", type:"",
    action:"EVENT_REMOVE",
    stepNo:"", stepName:"",
    detail:`${ev.date} ${ev.slot} ${ev.title}`,
    remarkSnapshot:"", mSnapshot:"",
    blockerTag:"",
    logId: uid("L")
  });

  toast("‡∏•‡∏ö event ‡πÅ‡∏•‡πâ‡∏ß");
  renderAll();
}

/** ======================
 * RENDER
 * ======================= */
function getSelected(){
  return selectedId ? active.circuits[selectedId] : null;
}

function renderKpi(){
  const list = Object.values(active.circuits || {});
  const total = list.length;
  const dia = list.filter(c=>c.type==="DIA").length;
  const dplc = list.filter(c=>c.type==="DPLC").length;
  const avg = total ? Math.round(list.reduce((a,c)=>a+percentOf(c),0)/total) : 0;
  const stuck = list.filter(c=>(c.remark||"").trim().length>0 && !isCompleted(c)).length;

  $("kpi").innerHTML = `
    <div class="box"><div class="n">${total}</div><div class="t">Active ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
    <div class="box"><div class="n">${dia}</div><div class="t">DIA</div></div>
    <div class="box"><div class="n">${dplc}</div><div class="t">DPLC</div></div>
    <div class="box"><div class="n">${avg}%</div><div class="t">Avg progress</div></div>
    <div class="box"><div class="n">${stuck}</div><div class="t">‡∏°‡∏µ Remark/‡∏ï‡∏¥‡∏î</div></div>
  `;
}

function renderCircuitList(){
  const q = ($("search").value||"").toLowerCase().trim();
  const ft = $("filterType").value;

  let list = Object.values(active.circuits || {});
  if(ft!=="ALL") list = list.filter(c=>c.type===ft);
  if(q) list = list.filter(c=>[c.sof,c.cid,c.name,c.m].some(v=>(v||"").toLowerCase().includes(q)));

  const mode = $("sortMode").value;
  list.sort((a,b)=>{
    if(mode==="lastUpdate") return (b.lastUpdateDate||"").localeCompare(a.lastUpdateDate||"") || (b.lastUpdateTime||"").localeCompare(a.lastUpdateTime||"");
    if(mode==="percent") return percentOf(b)-percentOf(a);
    if(mode==="name") return (a.name||"").localeCompare(b.name||"");
    if(mode==="created") return (a.createdAt||"").localeCompare(b.createdAt||"");
    return 0;
  });

  $("circuitList").innerHTML = list.map(c=>{
    const pct = percentOf(c);
    const nxt = nextStepIndex(c);
    const nxtText = (nxt===null) ? "DONE" : `${nxt+1}. ${STEPS[nxt]}`;
    const remark = (c.remark||"").trim();
    const m = (c.m||"").trim();
    const activeCls = (selectedId===c.id) ? "active" : "";

    return `
      <div class="item ${activeCls}" data-id="${c.id}">
        <div class="title">${escapeHtml(c.name)}</div>
        <div class="meta">
          <span class="pill">${c.type}</span>
          <span class="pill">SOF: <span class="mono">${escapeHtml(c.sof)}</span></span>
          <span class="pill">CID: <span class="mono">${escapeHtml(c.cid)}</span></span>
          ${m?`<span class="pill">M: <span class="mono">${escapeHtml(m)}</span></span>`:""}
        </div>
        <div style="margin-top:8px;" class="bar"><div style="width:${pct}%"></div></div>
        <div class="muted small" style="margin-top:8px;">
          <b class="mono">${pct}%</b> ‚Ä¢ Next: ${escapeHtml(nxtText)}
          <div class="muted small">Install: <span class="mono">${escapeHtml(c.installDate||"-")}</span></div>
          ${remark?`<div class="muted small"><span style="color:var(--warn);font-weight:900;">Remark:</span> ${escapeHtml(remark)}</div>`:""}
          <div class="muted small">Last: <span class="mono">${escapeHtml(lastUpdateStamp(c))}</span></div>
        </div>
      </div>
    `;
  }).join("") || `<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</div>`;

  $("circuitList").querySelectorAll(".item").forEach(el=>{
    el.addEventListener("click", ()=>{
      selectedId = el.dataset.id;
      switchTab("detail");
    });
  });
}

function renderDashboard(){
  const m = getMonthly(currentYM);
  const logs = (m.logs || []).slice().reverse().slice(0,120);

  $("logTable").innerHTML = logs.map(l=>{
    return `
      <tr>
        <td class="mono">${escapeHtml(l.doneAt||"")}</td>
        <td class="mono">${escapeHtml(l.cid||"")}</td>
        <td class="mono">${escapeHtml(l.action||"")}</td>
        <td class="mono">${l.stepNo?escapeHtml(String(l.stepNo)):""} ${l.stepName?escapeHtml(l.stepName):""}</td>
        <td>${escapeHtml(l.detail||"")}</td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="5" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ log ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</td></tr>`;

  // work status
  rebuildWorkStatus();
  const ws = getMonthly(currentYM).workStatus || [];
  $("wsTable").innerHTML = ws
    .slice()
    .sort((a,b)=> (b.lastUpdateAt||"").localeCompare(a.lastUpdateAt||""))
    .map(r=>{
      return `
        <tr>
          <td class="mono"><b>${escapeHtml(r.cid)}</b><div class="muted small">${escapeHtml(r.type)} ‚Ä¢ ${escapeHtml(r.name||"")}</div></td>
          <td class="mono">${escapeHtml(String(r.progressPercent||0))}%</td>
          <td class="mono">${r.nextStepNo?escapeHtml(String(r.nextStepNo)):""} ${escapeHtml(r.nextStepName||"")}</td>
          <td class="mono">${escapeHtml(r.installDate||"-")}</td>
          <td>${(r.remark||"").trim()?escapeHtml(r.remark):"<span class='muted'>-</span>"}</td>
          <td class="mono">${escapeHtml(r.lastUpdateAt||"")}</td>
        </tr>
      `;
    }).join("") || `<tr><td colspan="6" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Work_Status</td></tr>`;
}

function renderDetail(){
  const c = getSelected();
  if(!c){
    $("noSelected").style.display="";
    $("detailPanel").style.display="none";
    return;
  }
  $("noSelected").style.display="none";
  $("detailPanel").style.display="";

  const pct = percentOf(c);
  $("dType").textContent=c.type;
  $("dPct").textContent=`${pct}%`;
  $("dLast").textContent=lastUpdateStamp(c);
  $("dInstall").textContent=c.installDate || "-";
  $("dBar").style.width=`${pct}%`;

  $("editSof").value=c.sof||"";
  $("editCid").value=c.cid||"";
  $("editName").value=c.name||"";
  $("editM").value=c.m||"";

  $("installDate").value = c.installDate || "";
  $("installNote").value = c.installNote || "";

  $("remark").value = c.remark || "";

  $("steps").innerHTML = STEPS.map((name, idx)=>{
    const done = isStepDone(c,idx);
    const date = done ? (c.stepsDone[idx].date||"-") : "";
    return `
      <div class="step">
        <input type="checkbox" data-step="${idx}" ${done?"checked":""} />
        <div style="flex:1;">
          <div class="name">${idx+1}. ${escapeHtml(name)} ${idx===STEP_DONE_IDX?`<span class="pill good">DONE</span>`:""}</div>
          <div class="muted small">${done?`‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span class="mono">${escapeHtml(date)}</span>`:"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥"}</div>
        </div>
      </div>
    `;
  }).join("");

  $("steps").querySelectorAll("input[type=checkbox][data-step]").forEach(cb=>{
    cb.addEventListener("change", ()=>{
      const idx = Number(cb.dataset.step);
      toggleStep(c, idx, cb.checked);
    });
  });
}

function renderEvents(){
  const m = getMonthly(currentYM);
  const evs = (m.events || []).slice().sort((a,b)=>(a.date||"").localeCompare(b.date||"") || (a.slot||"").localeCompare(b.slot||""));
  $("evTable").innerHTML = evs.map(e=>{
    return `
      <tr>
        <td class="mono">${escapeHtml(e.date||"")}</td>
        <td class="mono">${escapeHtml(e.slot||"")}</td>
        <td><b>${escapeHtml(e.title||"")}</b></td>
        <td>${(e.note||"").trim()?escapeHtml(e.note):"<span class='muted'>-</span>"}</td>
        <td><button class="btn danger" data-del="${escapeHtml(e.eventId)}">Del</button></td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="5" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ events ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</td></tr>`;

  $("evTable").querySelectorAll("button[data-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.del;
      if(!confirm("‡∏•‡∏ö event ‡∏ô‡∏µ‡πâ?")) return;
      deleteEvent(id);
    });
  });
}

function renderAll(){
  currentYM = ymNow();
  renderKpi();
  renderCircuitList();
  renderDashboard();
  renderDetail();
  renderEvents();
  updateHeaderPills();
}

/** ======================
 * SYNC (only if changed) + AUTO EVERY 60 MIN
 * ======================= */
let isSyncing = false;

function stableHash(obj){
  // simple deterministic hash using JSON string
  const s = JSON.stringify(obj);
  let h = 2166136261;
  for(let i=0;i<s.length;i++){
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return (h>>>0).toString(16);
}

async function syncNow(){
  if(isSyncing) return false;
  if(!session || !session.user || !session.pass || !APPS_SCRIPT_URL){ toast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Login / ‡πÑ‡∏°‡πà‡∏°‡∏µ URL"); return false; }

  isSyncing = true;
  try{
    const savedYM = localStorage.getItem(ACTIVE_MONTH_KEY) || currentYM;
    const thisYM = ymNow();
    currentYM = thisYM;

    // rebuild Work_Status before syncing
    rebuildWorkStatus();
    const m = getMonthly(thisYM);

    // only sync when dirty or hash changed
    const payloadData = {
      logs: (m.logs || []),
      events: (m.events || []),
      workStatus: (m.workStatus || [])
    };
    const h = stableHash(payloadData);

    if(!m.dirty && m.lastHash === h){
      toast("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á sync)");
      return true;
    }

    $("pillSync").textContent = "sync: syncing...";

    // Apps Script expects: x-www-form-urlencoded payload=<json>
    const body = {
      user: session.user,
      pass: session.pass,
      ym: thisYM,
      data: payloadData
    };

    const form = new URLSearchParams();
    form.set("payload", JSON.stringify(body));

    const res = await fetch(APPS_SCRIPT_URL, {
      method:"POST",
      headers: { "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
      body: form.toString()
    });

    const j = await res.json().catch(()=>null);
    if(!res.ok || !j || !j.ok){
      toast("Sync fail: " + (j?.error || res.status));
      return false;
    }

    // mark synced
    m.dirty = false;
    m.lastHash = h;
    m.lastSyncAt = doneAtStr();
    setMonthly(thisYM, m);

    // month changed? -> rollover after successful sync
    if(savedYM !== thisYM){
      rolloverToNewMonth(thisYM);
      toast("‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ‡∏•‡πâ‡∏≤‡∏á log ‡πÄ‡∏Å‡πà‡∏≤ (‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á)");
    }else{
      toast("Sync ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }

    renderAll();
    return true;

  } catch(e){
    toast("Sync error");
    return false;
  } finally{
    isSyncing = false;
    updateHeaderPills();
  }
}

$("btnSyncNow").addEventListener("click", syncNow);

// auto sync every 60 minutes
setInterval(()=>{ syncNow(); }, 60*60*1000);

// also try sync on load (optional)
window.addEventListener("focus", ()=>{ syncNow(); });

/** ======================
 * INIT
 * ======================= */
(function init(){
  ensureActiveMonth();

  // load api url if exists
  APPS_SCRIPT_URL = localStorage.getItem("provi_api_url") || "";

  // if no session -> login
  session = loadJSON(SESSION_KEY, null);
  active  = loadJSON(ACTIVE_KEY, {circuits:{}});

  if(!session){
    showLogin();
    return;
  }
  showApp();
  renderAll();
})();
</script>
</body>
</html>
