<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Provi/PM ‚Äì Circuit Tracker</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121a24; --muted:#8aa0b8; --text:#e7f0fb; --line:#223043;
      --accent:#ff7a18; --accent2:#ff9a3c;
      --warn:#f1c40f; --bad:#ff5c7a; --good:#32d583; --chip:#182434;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#0b0f14,#070a0d);color:var(--text);}
    header{position:sticky;top:0;z-index:10;background:rgba(11,15,20,.86);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);}
    .wrap{max-width:1500px;margin:0 auto;padding:14px;}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    .spacer{flex:1}
    h1{margin:0;font-size:16px;}
    .sub{color:var(--muted);font-size:12px;margin-top:4px;}
    .btn{border:1px solid var(--line);background:var(--card);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:900;}
    .btn:hover{border-color:#2f425d}
    .btn.primary{background:linear-gradient(180deg, rgba(255,122,24,.95), rgba(216,95,15,.95));border-color: rgba(255,122,24,.55);color:#1a0d05;}
    .btn.danger{background:linear-gradient(180deg,#5a1c2a,#3a101b);border-color:#a52b47}
    .btn[disabled]{opacity:.45;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--line);font-size:11px;color:#cfe3ff;white-space:nowrap;}
    .pill.warn{border-color:#6b5a14;color:#ffeaa7}
    .pill.bad{border-color:#6b1f2f;color:#ffd1dc}
    .pill.good{border-color:#1c5a3a;color:#d1ffe6}
    .card{background:rgba(18,26,36,.92);border:1px solid var(--line);border-radius:16px;padding:14px;}
    .muted{color:var(--muted);font-size:12px;}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{width:100%;background:#0e1520;border:1px solid var(--line);color:var(--text);padding:10px;border-radius:12px;outline:none;}
    textarea{min-height:54px;resize:vertical}
    .grid{display:grid;gap:12px;}
    @media(min-width:1100px){ .grid.app{grid-template-columns:430px 1fr;} }
    table{width:100%;border-collapse:collapse;}
    th,td{border-bottom:1px solid var(--line);padding:8px;vertical-align:top;font-size:12px;}
    th{color:#cfe3ff;text-align:left;font-weight:900;background:rgba(24,36,52,.6);position:sticky;top:0;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:#0e1520;color:var(--text);cursor:pointer;font-weight:900;font-size:12px;}
    .tab.active{border-color:rgba(255,122,24,.55);background:rgba(255,122,24,.12)}
    .item{background:#0e1520;border:1px solid var(--line);border-radius:14px;padding:10px;cursor:pointer;}
    .item:hover{border-color:#2f425d}
    .item.active{border-color:rgba(255,122,24,.55);box-shadow:0 0 0 2px rgba(255,122,24,.08) inset;}
    .item .title{font-weight:900;font-size:13px;margin-bottom:6px;}
    .item .meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:11px;}
    .bar{height:8px;background:#0b0f14;border:1px solid var(--line);border-radius:999px;overflow:hidden;}
    .bar > div{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%;}
    .step{display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid var(--line);border-radius:14px;background:#0e1520;margin-top:8px;}
    .step input[type="checkbox"]{width:18px;height:18px;margin-top:2px;}
    .step .name{font-weight:900;font-size:12px;}
    .step .done{color:#bfe9ff;font-size:11px;margin-top:4px;}
    .toast{position:fixed;right:16px;bottom:16px;background:#0e1520;border:1px solid var(--line);padding:10px 12px;border-radius:12px;display:none;z-index:80;}
    .calHead{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px;}
    .calDow{font-size:11px;color:#cfe3ff;background:rgba(24,36,52,.6);border:1px solid var(--line);border-radius:12px;padding:8px;text-align:center;font-weight:900;}
    .calCell{min-height:120px;background:#0e1520;border:1px solid var(--line);border-radius:14px;padding:8px;display:flex;flex-direction:column;gap:6px;cursor:pointer;}
    .calCell:hover{border-color:#2f425d}
    .calCell.dim{opacity:.45}
    .calCell .dateRow{display:flex;gap:8px;align-items:center;}
    .calCell .dnum{font-weight:900;}
    .chip{display:flex;gap:6px;align-items:center;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:11px;background:#101a27;overflow:hidden}
    .chip.install{border-color:rgba(255,122,24,.55)}
    .chip.event{border-color:#5a4d1c}
    .chip.eventAll{border-color:#7a5b1c}
    .chip.bad{border-color:#7a2840}
    .chips{display:flex;flex-direction:column;gap:6px;overflow:hidden}
    .modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:70;}
    .modal{width:min(980px,96vw);max-height:90vh;overflow:auto;background:#0e1520;border:1px solid var(--line);border-radius:16px;padding:14px;}
    .modal h3{margin:0;font-size:14px;}
    .split{display:grid;gap:12px;}
    @media(min-width:900px){ .split{grid-template-columns:1fr 1fr;} }
    .small{font-size:11px}
    .warnTxt{color:var(--warn)}
    .badTxt{color:var(--bad)}
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .kpi .box{flex:1;min-width:150px;background:#0e1520;border:1px solid var(--line);border-radius:14px;padding:10px;}
    .box .n{font-size:18px;font-weight:900;}
    .box .t{font-size:11px;color:var(--muted);}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row">
      <div>
        <h1>Provi/PM ‚Äì Circuit Tracker</h1>
        <div class="sub">Circuit ‚Ä¢ Logs ‚Ä¢ Events ‚Ä¢ Sync ‡πÑ‡∏õ Google Drive (Apps Script)</div>
      </div>
      <div class="spacer"></div>

      <span class="pill" id="userPill">user: -</span>
      <span class="pill" id="dirtyPill">dirty: no</span>

      <button class="btn" id="btnSync">Sync now</button>
      <button class="btn danger" id="btnForce">Force sync</button>
      <button class="btn" id="btnOpenDrive">Open Drive</button>

      <a class="btn" href="index.html">Back</a>
    </div>
    <div class="row" style="margin-top:10px;">
      <span class="muted small mono" id="syncStatus">-</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid app">
    <aside class="card">
      <div class="row">
        <h2 style="margin:0;font-size:14px;">Circuits</h2>
        <div class="spacer"></div>
        <span class="pill" id="todayPill"></span>
      </div>

      <div class="kpi" id="kpi"></div>

      <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
      <input id="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ SOF / CID / ‡∏ä‡∏∑‡πà‡∏≠ / M" />

      <div class="row">
        <div style="flex:1;min-width:180px;">
          <label>‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
          <select id="filterType">
            <option value="ALL">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="DIA">DIA (CID ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô C)</option>
            <option value="DPLC">DPLC (CID ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô P)</option>
          </select>
        </div>
        <div style="flex:1;min-width:180px;">
          <label>‡πÄ‡∏£‡∏µ‡∏¢‡∏á</label>
          <select id="sortMode">
            <option value="lastUpdate">Last update ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
            <option value="percent">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏°‡∏≤‡∏Å‚Üí‡∏ô‡πâ‡∏≠‡∏¢</option>
            <option value="name">‡∏ä‡∏∑‡πà‡∏≠ A‚ÜíZ</option>
            <option value="created">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‚Üí‡∏´‡∏•‡∏±‡∏á</option>
          </select>
        </div>
      </div>

      <div id="circuitList" style="display:flex;flex-direction:column;gap:10px;margin-top:10px;"></div>
    </aside>

    <section class="card">
      <div class="row">
        <h2 id="rightTitle" style="margin:0;font-size:14px;">Dashboard</h2>
        <div class="spacer"></div>
        <button class="btn" id="btnGoDashboard">Dashboard</button>
      </div>

      <div class="tabs">
        <button class="tab active" data-rtab="dashboard">Dashboard</button>
        <button class="tab" data-rtab="detail">Circuit Detail</button>
        <button class="tab" data-rtab="daily">Daily Log</button>
        <button class="tab" data-rtab="calendar">Calendar</button>
      </div>

      <div id="rtab-dashboard" style="margin-top:10px;">
        <div class="row">
          <button class="btn primary" id="btnToggleAdd">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏á‡∏à‡∏£‡πÉ‡∏´‡∏°‡πà</button>
          <span class="muted small" id="addHint"></span>
          <div class="spacer"></div>
        </div>

        <div id="addPanel" class="card" style="display:none;background:#0e1520;border-color:var(--line);margin-top:10px;">
          <div class="row">
            <div style="font-weight:900;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏á‡∏à‡∏£‡πÉ‡∏´‡∏°‡πà</div>
            <div class="spacer"></div>
            <span class="muted small">Type auto ‡∏à‡∏≤‡∏Å CID ‚Ä¢ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ M ‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô M123 ‡∏´‡∏£‡∏∑‡∏≠ M123,M124</span>
          </div>
          <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr 1.2fr 1fr auto;margin-top:10px;">
            <div>
              <label style="margin-top:0;">SOF</label>
              <input id="addSof" placeholder="SOF" />
            </div>
            <div>
              <label style="margin-top:0;">CID</label>
              <input id="addCid" placeholder="CID (C... ‡∏´‡∏£‡∏∑‡∏≠ P...)" />
            </div>
            <div>
              <label style="margin-top:0;">‡∏ä‡∏∑‡πà‡∏≠</label>
              <input id="addName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô" />
            </div>
            <div>
              <label style="margin-top:0;">‡∏°‡∏µ M ‡πÑ‡∏´‡∏° (‡∏£‡∏∞‡∏ö‡∏∏ M)</label>
              <input id="addM" placeholder="‡πÄ‡∏ä‡πà‡∏ô M123 ‡∏´‡∏£‡∏∑‡∏≠ M123,M124" />
            </div>
            <div style="display:flex;align-items:flex-end;">
              <button class="btn primary" id="btnAddCircuit" style="width:120px;">Add</button>
            </div>
          </div>
        </div>

        <div style="display:grid;gap:12px;grid-template-columns:1fr 1fr;margin-top:12px;">
          <div>
            <label>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á (Log ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</label>
            <div style="max-height:340px;overflow:auto;border:1px solid var(--line);border-radius:14px;">
              <table>
                <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ß‡∏á‡∏à‡∏£/‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå</th><th>Action</th><th>Detail</th></tr></thead>
                <tbody id="todayLogTable"></tbody>
              </table>
            </div>
          </div>
          <div>
            <label>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (Progress / Next / Install / Remark)</label>
            <div style="max-height:340px;overflow:auto;border:1px solid var(--line);border-radius:14px;">
              <table>
                <thead><tr><th>‡∏ß‡∏á‡∏à‡∏£</th><th>%</th><th>Next</th><th>Install</th><th>Remark</th></tr></thead>
                <tbody id="overviewTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div id="rtab-detail" style="display:none;margin-top:10px;">
        <div id="noSelected" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏á‡∏à‡∏£ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å list ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢)</div>

        <div id="detailPanel" style="display:none;">
          <div class="row" style="align-items:flex-start;">
            <div style="flex:1;">
              <div class="row">
                <span class="pill">Type: <b id="dType">-</b></span>
                <span class="pill">Progress: <b id="dPct">0%</b></span>
                <span class="pill">Last: <span class="mono" id="dLast">-</span></span>
                <span class="pill">Install: <span class="mono" id="dInstall">-</span></span>
              </div>
              <div style="margin-top:10px;" class="bar"><div id="dBar"></div></div>
            </div>
            <div><button class="btn danger" id="btnDelete">Delete</button></div>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn" id="btnToggleMeta">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏á‡∏à‡∏£ (SOF/CID/‡∏ä‡∏∑‡πà‡∏≠/M)</button>
            <div class="spacer"></div>
          </div>
          <div id="metaPanel" class="card" style="display:none;background:#0e1520;border-color:var(--line);margin-top:10px;">
            <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr 1.2fr 1fr;">
              <div><label>SOF</label><input id="editSof" /></div>
              <div><label>CID</label><input id="editCid" /></div>
              <div><label>‡∏ä‡∏∑‡πà‡∏≠</label><input id="editName" /></div>
              <div><label>M (‡∏£‡∏∞‡∏ö‡∏∏ M ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input id="editM" /></div>
            </div>
            <div class="row" style="margin-top:10px;">
              <button class="btn primary" id="btnSaveMeta">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
              <div class="spacer"></div>
              <button class="btn" id="btnCloseMeta">Close</button>
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn" id="btnToggleInstall">üìå ‡∏ï‡∏±‡πâ‡∏á/‡πÅ‡∏Å‡πâ‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</button>
            <div class="spacer"></div>
          </div>
          <div id="installPanel" class="card" style="display:none;background:#0e1520;border-color:var(--line);margin-top:10px;">
            <div style="display:grid;gap:10px;grid-template-columns:240px 1fr auto;">
              <div>
                <label style="margin-top:0;">Install date</label>
                <input type="date" id="installDate" />
              </div>
              <div>
                <label style="margin-top:0;">Note (optional)</label>
                <input id="installNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô onsite / ‡∏ô‡∏±‡∏î‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤ / ‡∏Ñ‡∏∏‡∏°‡∏á‡∏≤‡∏ô" />
              </div>
              <div style="display:flex;align-items:flex-end;gap:10px;">
                <button class="btn primary" id="btnSaveInstall">Save</button>
                <button class="btn danger" id="btnClearInstall">Clear</button>
              </div>
            </div>
          </div>

          <label style="margin-top:14px;">Remark (‡∏ï‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£/‡∏£‡∏≠‡πÉ‡∏Ñ‡∏£)</label>
          <input id="remark" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠ IP / ‡∏£‡∏≠ WHA / ‡∏£‡∏≠‡∏Ç‡∏≠‡∏á" />
          <div class="row" style="margin-top:10px;">
            <button class="btn primary" id="btnSaveRemark">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Remark</button>
            <div class="spacer"></div>
          </div>

          <div style="margin-top:14px;">
            <h3 style="margin:0 0 6px 0;font-size:13px;">Checklist (21 ‡∏Ç‡∏±‡πâ‡∏ô)</h3>
            <div id="steps"></div>
          </div>
        </div>
      </div>

      <div id="rtab-daily" style="display:none;margin-top:10px;">
        <div class="row">
          <div style="flex:1;min-width:240px;">
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="logDate" />
          </div>
          <div style="flex:1;min-width:240px;">
            <label>‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏á‡∏à‡∏£</label>
            <select id="logCircuit"></select>
          </div>
        </div>

        <div style="margin-top:10px;max-height:620px;overflow:auto;border:1px solid var(--line);border-radius:14px;">
          <table>
            <thead>
              <tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>SOF</th><th>CID</th><th>Type</th><th>Action</th><th>Step</th><th>Detail</th><th>Remark</th><th>M</th><th>User</th></tr>
            </thead>
            <tbody id="dailyBody"></tbody>
          </table>
        </div>
      </div>

      <div id="rtab-calendar" style="display:none;margin-top:10px;">
        <div class="muted">Calendar ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Events)</div>
      </div>

    </section>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  /** ===== CONFIG ===== */
  const API_URL = "https://script.google.com/macros/s/PUT_YOUR_SCRIPT_URL/exec";
  const ROOT_FOLDER_ID = "1sxBCtzxb7J_Hkw_9o_klPkQHHXLyMtIk";
  const AUTO_SYNC_MINUTES = 60;

  const SESSION_KEY = "provi_session"; // {user,pass,ymLastSync}
  const DIRTY_KEY_PREFIX = "provi_dirty_";
  const KEY_PREFIX = "provi_tracker_v4_"; // bump version

  const $ = (id) => document.getElementById(id);

  /** ===== steps ===== */
  const STEPS = [
    "‡∏à‡∏≠‡∏á SID","‡∏™‡∏£‡πâ‡∏≤‡∏á SID ‡∏ö‡∏ô CMDB","‡∏™‡∏£‡πâ‡∏≤‡∏á Folder ‡πÑ‡∏î‡∏ü‡πå‡∏Å‡∏•‡∏≤‡∏á","‡πÄ‡∏õ‡∏¥‡∏î Task ‡πÑ‡∏õ‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á",
    "‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô/‡∏™‡∏£‡∏∏‡∏õ requirement ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö","‡πÄ‡∏ä‡πá‡∏Ñ stock / ‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á","‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° config ‡∏ï‡∏≤‡∏°‡∏ß‡∏á‡∏à‡∏£","‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°",
    "‡∏ó‡∏≥ 147","‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å Node","Shape Bandwidth","Add Zabbix + SMS Alert (‡∏ñ‡πâ‡∏≤ SOF ‡∏£‡∏∞‡∏ö‡∏∏)","Add Graph",
    "‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏ú‡∏ô‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á + ‡∏ô‡∏±‡∏î‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå","‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤","‡∏õ‡∏¥‡∏î SR","Update Inventory",
    "Update CMDB","Update CMDB (final check)","‡∏ó‡∏≥ F-108","‡∏õ‡∏¥‡∏î CR"
  ];

  /** ===== session / login ===== */
  function getSession(){
    try{ return JSON.parse(localStorage.getItem(SESSION_KEY) || "{}"); }catch{ return {}; }
  }
  function requireLogin(){
    const s = getSession();
    if(s.user && s.pass) return s;
    location.href = "index.html";
    return null;
  }
  const sess = requireLogin();
  if(!sess) return;

  const actor = sess.user;
  $("userPill").textContent = `user: ${actor}`;

  const KEY = KEY_PREFIX + actor;
  const DIRTY_KEY = DIRTY_KEY_PREFIX + actor;

  /** ===== date helpers ===== */
  function isoDate(d){
    const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function today(){ const d=new Date(); d.setHours(0,0,0,0); return d; }
  function todayStr(){ return isoDate(today()); }
  function nowTime(){
    const d=new Date(), hh=String(d.getHours()).padStart(2,"0"), mi=String(d.getMinutes()).padStart(2,"0"), ss=String(d.getSeconds()).padStart(2,"0");
    return `${hh}:${mi}:${ss}`;
  }
  function nowDateTimeStr(){
    return `${todayStr()} ${nowTime()}`;
  }
  function ymNowLocal(){
    const d=new Date();
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    return `${y}-${m}`;
  }

  /** ===== state ===== */
  function load(){ try { return JSON.parse(localStorage.getItem(KEY)); } catch { return null; } }
  function uid(prefix="X"){ return prefix + Math.random().toString(16).slice(2) + Date.now().toString(16); }

  const state = load() || { ym: ymNowLocal(), selectedId:null, circuits:{}, events:[], logs:{} };

  /** ===== AUTO-CLEAN when month changed =====
      - ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå logs + events ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà
      - ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á" (circuits ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà 100%)
  */
  function isDoneCircuit(c){ return percentOf(c) >= 100; }
  function autoCleanIfMonthChanged(){
    const nowYm = ymNowLocal();
    if(state.ym !== nowYm){
      // keep only unfinished circuits
      Object.keys(state.circuits||{}).forEach(id=>{
        const c=state.circuits[id];
        if(c && isDoneCircuit(c)) delete state.circuits[id];
      });
      state.logs = {};   // reset logs
      state.events = []; // reset events
      state.selectedId = null;
      state.ym = nowYm;
      save(true);
      toast(`‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß: reset logs/events (${nowYm})`);
    }
  }

  function save(silent=false){
    localStorage.setItem(KEY, JSON.stringify(state));
    setDirty(true);
    if(!silent) toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
  }

  function toast(msg){
    const t=$("toast");
    t.textContent=msg;
    t.style.display="block";
    clearTimeout(toast._t);
    toast._t=setTimeout(()=>t.style.display="none",1400);
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }

  function inferTypeFromCID(cid){
    const c=(cid||"").trim().toUpperCase();
    if(c.startsWith("C")) return "DIA";
    if(c.startsWith("P")) return "DPLC";
    return "INVALID";
  }

  function ensureLogDate(date){ if(!state.logs[date]) state.logs[date]=[]; }
  function touchUpdate(c){ c.updatedAt=Date.now(); c.lastUpdateAt=nowDateTimeStr(); }

  function isStepDone(c, idx){ return !!(c.stepsDone && c.stepsDone[idx] && c.stepsDone[idx].done); }
  function percentOf(c){
    const doneCount = STEPS.reduce((a,_,i)=>a+(isStepDone(c,i)?1:0),0);
    return Math.round((doneCount/STEPS.length)*100);
  }
  function nextStepIndex(c){
    for(let i=0;i<STEPS.length;i++) if(!isStepDone(c,i)) return i;
    return null;
  }
  function getSelected(){ return state.selectedId ? state.circuits[state.selectedId] : null; }

  /** ===== dirty flag ===== */
  function isDirty(){ return localStorage.getItem(DIRTY_KEY)==="1"; }
  function setDirty(v){
    if(v) localStorage.setItem(DIRTY_KEY,"1");
    else localStorage.removeItem(DIRTY_KEY);
    $("dirtyPill").textContent = "dirty: " + (isDirty() ? "YES" : "no");
    $("dirtyPill").classList.toggle("warn", isDirty());
  }

  /** ===== logging (FULL columns for sheet) =====
      Logs columns (MUST match Code.gs header):
      ym,date,time,doneAt,user,action,sof,cid,type,stepNo,stepName,detail,remarkSnapshot,mSnapshot,blockerTag,logId
  */
  function addLogCircuit(c, action, detail, opts={}){
    const d=todayStr(), t=nowTime();
    const doneAt = `${d} ${t}`;
    ensureLogDate(d);
    state.logs[d].push({
      ym: ymNowLocal(),
      date: d,
      time: t,
      doneAt,
      user: actor,
      action,
      sof: c.sof||"",
      cid: c.cid||"",
      type: c.type||"",
      stepNo: opts.stepNo ?? "",
      stepName: opts.stepName ?? "",
      detail: detail || "",
      remarkSnapshot: (c.remark||"").trim(),
      mSnapshot: (c.m||"").trim(),
      blockerTag: opts.blockerTag ?? "",
      logId: uid("L")
    });
  }
  function addLogSystem(action, detail, opts={}){
    const d=todayStr(), t=nowTime();
    const doneAt = `${d} ${t}`;
    ensureLogDate(d);
    state.logs[d].push({
      ym: ymNowLocal(),
      date: d,
      time: t,
      doneAt,
      user: actor,
      action,
      sof: "",
      cid: "",
      type: "",
      stepNo: opts.stepNo ?? "",
      stepName: opts.stepName ?? "",
      detail: detail || "",
      remarkSnapshot: "",
      mSnapshot: "",
      blockerTag: opts.blockerTag ?? "",
      logId: uid("L")
    });
  }

  /** ===== Sync payload builder =====
      Events header:
      ym,date,user,slot,title,note,eventId

      Work_Status header:
      ym,user,cid,type,sof,name,progressPercent,lastUpdateAt,nextStepNo,nextStepName,installDate,installNote,remark,m,updatedAt
  */
  function buildRowsForSheet(){
    const ym = ymNowLocal();

    // Logs rows
    const logsRows = [];
    Object.keys(state.logs||{}).sort().forEach(dateKey=>{
      (state.logs[dateKey]||[]).forEach(l=>{
        logsRows.push([
          l.ym||ym,
          l.date||"",
          l.time||"",
          l.doneAt||"",
          l.user||"",
          l.action||"",
          l.sof||"",
          l.cid||"",
          l.type||"",
          l.stepNo||"",
          l.stepName||"",
          l.detail||"",
          l.remarkSnapshot||"",
          l.mSnapshot||"",
          l.blockerTag||"",
          l.logId||""
        ]);
      });
    });

    // Events rows
    const eventsRows = (state.events||[])
      .slice()
      .sort((a,b)=>(a.date||"").localeCompare(b.date||"") || (a.slot||"").localeCompare(b.slot||""))
      .map(e=>[
        ym,
        e.date||"",
        actor,
        e.slot||"",
        e.title||"",
        e.note||"",
        e.id||""
      ]);

    // Work_Status rows
    const workStatusRows = Object.values(state.circuits||{})
      .slice()
      .sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0))
      .map(c=>{
        const pct = percentOf(c);
        const nxt = nextStepIndex(c);
        const nextNo = (nxt===null) ? 0 : (nxt+1);
        const nextName = (nxt===null) ? "DONE" : STEPS[nxt];
        return [
          ym,
          actor,
          c.cid||"",
          c.type||"",
          c.sof||"",
          c.name||"",
          pct,
          c.lastUpdateAt || "",
          nextNo,
          nextName,
          c.installDate||"",
          c.installNote||"",
          (c.remark||"").trim(),
          (c.m||"").trim(),
          String(c.updatedAt||"")
        ];
      });

    return { ym, logsRows, eventsRows, workStatusRows };
  }

  /** ===== after sync cleanup =====
      - ‡∏•‡∏ö logs ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ)
      - ‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö (localStorage)
      - ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á + state.ym ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  */
  function cleanupAfterSync(){
    // 1) remove done circuits
    Object.keys(state.circuits||{}).forEach(id=>{
      const c=state.circuits[id];
      if(c && isDoneCircuit(c)) delete state.circuits[id];
    });
    // 2) keep only current month logs (‡∏á‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏î: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏°‡∏î)
    state.logs = {};
    // 3) events ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡πá‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô [])
    // ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô "‡∏¢‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö events" ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠ "‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ" ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏¢
    // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á events ‡∏´‡∏•‡∏±‡∏á sync ‡∏î‡πâ‡∏ß‡∏¢ ‡πÉ‡∏´‡πâ uncomment:
    // state.events = [];

    save(true);
  }

  async function sendToScript({force=false}={}){
    if(!force && !isDirty()){
      $("syncStatus").textContent = "Skip: not dirty";
      return;
    }

    const { ym, logsRows, eventsRows, workStatusRows } = buildRowsForSheet();

    const packet = {
      user: sess.user,
      pass: sess.pass,
      ym,
      data: { logsRows, eventsRows, workStatusRows }
    };

    $("syncStatus").textContent = "Sending...";
    try{
      await fetch(API_URL, {
        method:"POST",
        mode:"no-cors",
        headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
        body: new URLSearchParams({ payload: JSON.stringify(packet) })
      });

      // mark clean + auto cleanup
      setDirty(false);
      cleanupAfterSync();

      $("syncStatus").textContent = `Sent ‚úÖ (${ym}) ‚Äî cleaned localStorage (keep unfinished + month summary)`;
      toast("Sync ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à + ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à/‡∏•‡πâ‡∏≤‡∏á logs ‡πÅ‡∏•‡πâ‡∏ß");
    }catch(e){
      $("syncStatus").textContent = "Sync failed: " + (e.message || e);
      toast("Sync ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }
  }

  function startAutoSync(){
    setInterval(async ()=>{
      try{
        if(!isDirty()) return;
        await sendToScript({force:false});
      }catch(_){}
    }, AUTO_SYNC_MINUTES*60*1000);
  }

  /** ===== UI tabs ===== */
  const tabsRight=[...document.querySelectorAll(".tab[data-rtab]")];
  const rDash=$("rtab-dashboard"), rDetail=$("rtab-detail"), rDaily=$("rtab-daily"), rCal=$("rtab-calendar");
  function switchRightTab(name){
    tabsRight.forEach(x=>x.classList.toggle("active", x.dataset.rtab===name));
    rDash.style.display = name==="dashboard" ? "" : "none";
    rDetail.style.display = name==="detail" ? "" : "none";
    rDaily.style.display = name==="daily" ? "" : "none";
    rCal.style.display = name==="calendar" ? "" : "none";
    $("rightTitle").textContent = name==="dashboard" ? "Dashboard" : name==="detail" ? "Circuit Detail" : name==="daily" ? "Daily Log" : "Calendar";
    renderAll(true);
  }

  /** ===== init static UI ===== */
  $("todayPill").textContent = `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ${todayStr()}`;
  $("logDate").value = todayStr();

  /** ===== header actions ===== */
  $("btnSync").addEventListener("click", ()=>sendToScript({force:false}));
  $("btnForce").addEventListener("click", ()=>sendToScript({force:true}));
  $("btnOpenDrive").addEventListener("click", ()=> window.open(`https://drive.google.com/drive/folders/${ROOT_FOLDER_ID}`, "_blank"));

  /** ===== dashboard add circuit ===== */
  $("btnToggleAdd").addEventListener("click", ()=> {
    const p=$("addPanel");
    p.style.display = (p.style.display==="none") ? "" : "none";
  });

  $("addCid").addEventListener("input", ()=>{
    const t=inferTypeFromCID($("addCid").value);
    $("addHint").textContent = t==="INVALID" ? "CID ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô C ‡∏´‡∏£‡∏∑‡∏≠ P" : `Type (auto): ${t}`;
  });

  $("btnAddCircuit").addEventListener("click", ()=>{
    const sof=($("addSof").value||"").trim();
    const cid=($("addCid").value||"").trim();
    const name=($("addName").value||"").trim();
    const m=($("addM").value||"").trim();
    if(!sof||!cid||!name){ toast("‡∏Å‡∏£‡∏≠‡∏Å SOF, CID, ‡∏ä‡∏∑‡πà‡∏≠ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); return; }
    const type=inferTypeFromCID(cid);
    if(type==="INVALID"){ toast("CID ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô C ‡∏´‡∏£‡∏∑‡∏≠ P"); return; }

    const id=uid("C");
    const c={
      id, sof, cid, name, type, m,
      remark:"",
      stepsDone:{},
      installDate:"",
      installNote:"",
      createdAt: todayStr(),
      lastUpdateAt: nowDateTimeStr(),
      updatedAt: Date.now()
    };
    state.circuits[id]=c;
    state.selectedId=id;

    addLogCircuit(c,"CIRCUIT_CREATE","‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏á‡∏à‡∏£‡πÉ‡∏´‡∏°‡πà");
    save(true);

    $("addSof").value=""; $("addCid").value=""; $("addName").value=""; $("addM").value="";
    $("addPanel").style.display="none";
    toast("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏á‡∏à‡∏£‡πÅ‡∏•‡πâ‡∏ß");
    switchRightTab("detail");
  });

  /** ===== detail bindings ===== */
  $("btnToggleMeta").addEventListener("click", ()=> {
    const p=$("metaPanel");
    p.style.display = (p.style.display==="none") ? "" : "none";
  });
  $("btnCloseMeta").addEventListener("click", ()=> $("metaPanel").style.display="none");

  $("btnSaveMeta").addEventListener("click", ()=>{
    const c=getSelected(); if(!c) return;
    const sof=($("editSof").value||"").trim();
    const cid=($("editCid").value||"").trim();
    const name=($("editName").value||"").trim();
    const m=($("editM").value||"").trim();
    if(!sof||!cid||!name){ toast("‡∏Å‡∏£‡∏≠‡∏Å SOF, CID, ‡∏ä‡∏∑‡πà‡∏≠ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); return; }
    const type=inferTypeFromCID(cid);
    if(type==="INVALID"){ toast("CID ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô C ‡∏´‡∏£‡∏∑‡∏≠ P"); return; }

    c.sof=sof; c.cid=cid; c.name=name; c.type=type; c.m=m;
    touchUpdate(c);
    addLogCircuit(c,"CIRCUIT_EDIT","‡πÅ‡∏Å‡πâ SOF/CID/‡∏ä‡∏∑‡πà‡∏≠/M");
    save(true);
    toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
    $("metaPanel").style.display="none";
    renderAll(true);
  });

  $("btnToggleInstall").addEventListener("click", ()=> {
    const p=$("installPanel");
    p.style.display = (p.style.display==="none") ? "" : "none";
  });

  $("btnSaveInstall").addEventListener("click", ()=>{
    const c=getSelected(); if(!c) return;
    c.installDate = $("installDate").value || "";
    c.installNote = ($("installNote").value||"").trim();
    touchUpdate(c);
    addLogCircuit(c,"INSTALL_SET",`‡∏ï‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ${c.installDate}${c.installNote?` (${c.installNote})`:``}`);
    save(true);
    toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
    $("installPanel").style.display="none";
    renderAll(true);
  });

  $("btnClearInstall").addEventListener("click", ()=>{
    const c=getSelected(); if(!c) return;
    const prev=c.installDate||"";
    c.installDate=""; c.installNote="";
    touchUpdate(c);
    addLogCircuit(c,"INSTALL_CLEAR",`‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á (‡πÄ‡∏î‡∏¥‡∏° ${prev})`);
    save(true);
    toast("‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
    $("installPanel").style.display="none";
    renderAll(true);
  });

  $("btnSaveRemark").addEventListener("click", ()=>{
    const c=getSelected(); if(!c) return;
    c.remark = ($("remark").value||"").trim();
    touchUpdate(c);
    addLogCircuit(c,"REMARK_UPDATE","‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Remark");
    save(true);
    toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Remark ‡πÅ‡∏•‡πâ‡∏ß");
    renderAll(true);
  });

  $("btnDelete").addEventListener("click", ()=>{
    const c=getSelected(); if(!c) return;
    if(!confirm(`‡∏•‡∏ö‡∏ß‡∏á‡∏à‡∏£‡∏ô‡∏µ‡πâ?\nSOF:${c.sof}\nCID:${c.cid}\n‡∏ä‡∏∑‡πà‡∏≠:${c.name}`)) return;
    addLogCircuit(c,"CIRCUIT_DELETE","‡∏•‡∏ö‡∏ß‡∏á‡∏à‡∏£");
    delete state.circuits[c.id];
    state.selectedId=null;
    save(true);
    toast("‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
    switchRightTab("dashboard");
  });

  /** ===== steps toggle ===== */
  function toggleStep(id, idx, checked){
    const c=state.circuits[id]; if(!c) return;
    if(!c.stepsDone) c.stepsDone={};
    if(!c.stepsDone[idx]) c.stepsDone[idx]={done:false,date:""};
    c.stepsDone[idx].done=checked;
    c.stepsDone[idx].date=checked?todayStr():"";
    touchUpdate(c);

    const stepNo = idx+1;
    const stepName = STEPS[idx];
    addLogCircuit(
      c,
      checked ? "STEP_CHECK" : "STEP_UNCHECK",
      `${stepNo}. ${stepName}`,
      { stepNo, stepName }
    );

    save(true);
    toast(checked?"‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏° + ‡∏•‡∏á log ‡πÅ‡∏•‡πâ‡∏ß":"‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏¥‡πä‡∏Å + ‡∏•‡∏á log ‡πÅ‡∏•‡πâ‡∏ß");

    // ‚úÖ ‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚Äú‡∏´‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‚Äù ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó‡∏´‡∏•‡∏±‡∏á sync ‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)
    if(isDoneCircuit(c)){
      toast("‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏ö 100% ‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏•‡∏±‡∏á Sync / ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞ Sync ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ)");
    }

    renderAll(true);
  }

  /** ===== daily filters ===== */
  $("logDate").addEventListener("change", renderDaily);
  $("logCircuit").addEventListener("change", renderDaily);

  /** ===== circuit list filters ===== */
  $("search").addEventListener("input", renderCircuitList);
  $("filterType").addEventListener("change", renderCircuitList);
  $("sortMode").addEventListener("change", renderCircuitList);

  tabsRight.forEach(b=> b.addEventListener("click", ()=> switchRightTab(b.dataset.rtab)));
  $("btnGoDashboard").addEventListener("click", ()=> switchRightTab("dashboard"));

  /** ===== render ===== */
  function renderAll(silent=false){
    setDirty(isDirty());
    renderKpi();
    renderCircuitList();
    renderDashboard();
    renderDetail();
    renderDailyCircuitOptions();
    renderDaily();
  }

  function renderKpi(){
    const circuits=Object.values(state.circuits);
    const total=circuits.length;
    const dia=circuits.filter(c=>c.type==="DIA").length;
    const dplc=circuits.filter(c=>c.type==="DPLC").length;
    const avg=total?Math.round(circuits.reduce((a,c)=>a+percentOf(c),0)/total):0;
    const hasRemark=circuits.filter(c=>(c.remark||"").trim().length>0 && percentOf(c)<100).length;
    $("kpi").innerHTML = `
      <div class="box"><div class="n">${total}</div><div class="t">‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà 100%)</div></div>
      <div class="box"><div class="n">${dia}</div><div class="t">DIA</div></div>
      <div class="box"><div class="n">${dplc}</div><div class="t">DPLC</div></div>
      <div class="box"><div class="n">${avg}%</div><div class="t">Avg progress</div></div>
      <div class="box"><div class="n">${hasRemark}</div><div class="t">‡∏°‡∏µ Remark/‡∏ï‡∏¥‡∏î</div></div>
    `;
  }

  function renderCircuitList(){
    const q = ($("search").value||"").toLowerCase().trim();
    const ft = $("filterType").value;
    let list = Object.values(state.circuits);

    if(ft!=="ALL") list=list.filter(c=>c.type===ft);
    if(q) list=list.filter(c=>[c.sof,c.cid,c.name,c.m].some(v=>(v||"").toLowerCase().includes(q)));

    const mode=$("sortMode").value;
    list.sort((a,b)=>{
      if(mode==="lastUpdate") return (b.updatedAt||0)-(a.updatedAt||0);
      if(mode==="percent") return percentOf(b)-percentOf(a);
      if(mode==="name") return (a.name||"").localeCompare(b.name||"");
      if(mode==="created") return (a.createdAt||"").localeCompare(b.createdAt||"");
      return 0;
    });

    $("circuitList").innerHTML = list.map(c=>{
      const pct=percentOf(c);
      const nxt=nextStepIndex(c);
      const nxtText=nxt===null?"‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß":`${nxt+1}. ${STEPS[nxt]}`;
      const remark=(c.remark||"").trim();
      const m=(c.m||"").trim();
      const installTxt = c.installDate ? c.installDate : "-";
      const active = state.selectedId===c.id ? "active" : "";
      return `
        <div class="item ${active}" data-id="${c.id}">
          <div class="title">${escapeHtml(c.name)}</div>
          <div class="meta">
            <span class="pill">${c.type}</span>
            <span class="pill">SOF: <span class="mono">${escapeHtml(c.sof)}</span></span>
            <span class="pill">CID: <span class="mono">${escapeHtml(c.cid)}</span></span>
            ${m?`<span class="pill">M: <span class="mono">${escapeHtml(m)}</span></span>`:""}
          </div>
          <div style="margin-top:8px;" class="bar"><div style="width:${pct}%"></div></div>
          <div class="muted small" style="margin-top:8px;">
            <b class="mono">${pct}%</b> ‚Ä¢ Next: ${escapeHtml(nxtText)}
            <div class="muted small">Install: <span class="mono">${escapeHtml(installTxt)}</span></div>
            ${remark?`<div class="muted small"><span class="warnTxt">Remark:</span> ${escapeHtml(remark)}</div>`:""}
            <div class="muted small">Last: <span class="mono">${escapeHtml(c.lastUpdateAt||"-")}</span></div>
          </div>
        </div>
      `;
    }).join("") || `<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</div>`;

    $("circuitList").querySelectorAll(".item").forEach(el=>{
      el.addEventListener("click", ()=>{
        state.selectedId = el.dataset.id;
        save(true);
        switchRightTab("detail");
      });
    });
  }

  function renderDashboard(){
    const d=todayStr(); ensureLogDate(d);
    const logs=(state.logs[d]||[]).slice().reverse();
    $("todayLogTable").innerHTML = logs.map(l=>{
      const name = l.cid ? `${l.cid}` : "SYSTEM";
      return `
        <tr>
          <td class="mono">${escapeHtml(l.time)}</td>
          <td><b>${escapeHtml(name)}</b><div class="muted small">${escapeHtml(l.sof||"")} ‚Ä¢ ${escapeHtml(l.type||"")}</div></td>
          <td class="mono">${escapeHtml(l.action)}</td>
          <td>${escapeHtml(l.detail||"")}</td>
        </tr>
      `;
    }).join("") || `<tr><td colspan="4" class="muted">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ log</td></tr>`;

    const circuits=Object.values(state.circuits).slice().sort((a,b)=>percentOf(b)-percentOf(a));
    $("overviewTable").innerHTML = circuits.slice(0,18).map(c=>{
      const pct=percentOf(c);
      const nxt=nextStepIndex(c);
      const nxtText=nxt===null?"DONE":`${nxt+1}. ${STEPS[nxt]}`;
      const remark=(c.remark||"").trim();
      const install = c.installDate ? c.installDate : "-";
      return `
        <tr>
          <td><b>${escapeHtml(c.name)}</b><div class="muted small">${escapeHtml(c.type)} ‚Ä¢ ${escapeHtml(c.cid)}</div></td>
          <td class="mono">${pct}%</td>
          <td>${escapeHtml(nxtText)}</td>
          <td class="mono">${escapeHtml(install)}</td>
          <td>${remark?escapeHtml(remark):"<span class='muted'>-</span>"}</td>
        </tr>
      `;
    }).join("") || `<tr><td colspan="5" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</td></tr>`;
  }

  function renderDetail(){
    const c=getSelected();
    if(!c){
      $("noSelected").style.display="";
      $("detailPanel").style.display="none";
      return;
    }
    $("noSelected").style.display="none";
    $("detailPanel").style.display="";

    const pct=percentOf(c);
    $("dType").textContent=c.type;
    $("dPct").textContent=`${pct}%`;
    $("dLast").textContent=c.lastUpdateAt||"-";
    $("dBar").style.width=`${pct}%`;
    $("dInstall").textContent = c.installDate ? c.installDate : "-";

    $("editSof").value=c.sof||"";
    $("editCid").value=c.cid||"";
    $("editName").value=c.name||"";
    $("editM").value=c.m||"";
    $("remark").value=c.remark||"";

    $("installDate").value = c.installDate || "";
    $("installNote").value = c.installNote || "";

    $("steps").innerHTML = STEPS.map((name, idx)=>{
      const done=isStepDone(c,idx);
      return `
        <div class="step">
          <input type="checkbox" data-step="${idx}" ${done?"checked":""} />
          <div style="flex:1;">
            <div class="name">${idx+1}. ${escapeHtml(name)}</div>
            ${done?`<div class="done">‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span class="mono">${escapeHtml(c.stepsDone[idx].date||"-")}</span></div>`:`<div class="done muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥</div>`}
          </div>
        </div>
      `;
    }).join("");

    $("steps").querySelectorAll("input[type=checkbox][data-step]").forEach(cb=>{
      cb.addEventListener("change", ()=>{
        const idx=Number(cb.dataset.step);
        toggleStep(c.id, idx, cb.checked);
      });
    });
  }

  function renderDailyCircuitOptions(){
    const sel=$("logCircuit");
    const list=Object.values(state.circuits).slice().sort((a,b)=>(a.name||"").localeCompare(b.name||""));
    sel.innerHTML = `<option value="">(‡∏ó‡∏∏‡∏Å‡∏ß‡∏á‡∏à‡∏£ + system)</option>` + list.map(c=>`<option value="${c.id}">${escapeHtml(c.name)} ‚Ä¢ ${escapeHtml(c.cid)}</option>`).join("");
  }

  function renderDaily(){
    const d=$("logDate").value||todayStr();
    ensureLogDate(d);
    const id=$("logCircuit").value||"";
    const logs=(state.logs[d]||[]).filter(l=>!id || (state.circuits[id] && l.cid===state.circuits[id].cid)).slice().reverse();

    $("dailyBody").innerHTML = logs.map(l=>{
      const step = l.stepNo ? `${l.stepNo}. ${l.stepName||""}` : "-";
      return `
        <tr>
          <td class="mono">${escapeHtml(l.time)}</td>
          <td class="mono">${escapeHtml(l.sof||"")}</td>
          <td class="mono">${escapeHtml(l.cid||"")}</td>
          <td>${escapeHtml(l.type||"")}</td>
          <td class="mono">${escapeHtml(l.action||"")}</td>
          <td>${escapeHtml(step)}</td>
          <td>${escapeHtml(l.detail||"")}</td>
          <td>${(l.remarkSnapshot||"").trim()?escapeHtml(l.remarkSnapshot):"<span class='muted'>-</span>"}</td>
          <td>${(l.mSnapshot||"").trim()?`<span class="mono">${escapeHtml(l.mSnapshot)}</span>`:"<span class='muted'>-</span>"}</td>
          <td>${escapeHtml(l.user||"")}</td>
        </tr>
      `;
    }).join("") || `<tr><td colspan="10" class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ log ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>`;
  }

  /** ===== startup ===== */
  autoCleanIfMonthChanged();
  setDirty(isDirty());
  renderAll(true);
  switchRightTab("dashboard");
  startAutoSync();
});
</script>
</body>
</html>
