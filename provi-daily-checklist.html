<!-- provi-daily-checklist.html (UPDATED: JSONP chunk + delta sync + logId/event createdAtMs) -->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Provi/PM ‚Äì Circuit Tracker</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121a24; --muted:#8aa0b8; --text:#e7f0fb; --line:#223043;
      --accent:#ff7a18; --accent2:#ff9a3c;
      --warn:#f1c40f; --bad:#ff5c7a; --good:#32d583; --chip:#182434;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#0b0f14,#070a0d);color:var(--text);}
    header{position:sticky;top:0;z-index:10;background:rgba(11,15,20,.86);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);}
    .wrap{max-width:1500px;margin:0 auto;padding:14px;}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    .spacer{flex:1}
    h1{margin:0;font-size:16px;}
    .sub{color:var(--muted);font-size:12px;margin-top:4px;}
    .btn{border:1px solid var(--line);background:var(--card);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:900;}
    .btn:hover{border-color:#2f425d}
    .btn.primary{background:linear-gradient(180deg, rgba(255,122,24,.95), rgba(216,95,15,.95));border-color: rgba(255,122,24,.55);color:#1a0d05;}
    .btn.danger{background:linear-gradient(180deg,#5a1c2a,#3a101b);border-color:#a52b47}
    .btn[disabled]{opacity:.45;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--line);font-size:11px;color:#cfe3ff;white-space:nowrap;}
    .pill.warn{border-color:#6b5a14;color:#ffeaa7}
    .pill.bad{border-color:#6b1f2f;color:#ffd1dc}
    .pill.good{border-color:#1c5a3a;color:#d1ffe6}
    .card{background:rgba(18,26,36,.92);border:1px solid var(--line);border-radius:16px;padding:14px;}
    .muted{color:var(--muted);font-size:12px;}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{width:100%;background:#0e1520;border:1px solid var(--line);color:var(--text);padding:10px;border-radius:12px;outline:none;}
    textarea{min-height:54px;resize:vertical}
    .grid{display:grid;gap:12px;}
    @media(min-width:1100px){ .grid.app{grid-template-columns:430px 1fr;} }
    table{width:100%;border-collapse:collapse;}
    th,td{border-bottom:1px solid var(--line);padding:8px;vertical-align:top;font-size:12px;}
    th{color:#cfe3ff;text-align:left;font-weight:900;background:rgba(24,36,52,.6);position:sticky;top:0;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:#0e1520;color:var(--text);cursor:pointer;font-weight:900;font-size:12px;}
    .tab.active{border-color:rgba(255,122,24,.55);background:rgba(255,122,24,.12)}
    .item{background:#0e1520;border:1px solid var(--line);border-radius:14px;padding:10px;cursor:pointer;}
    .item:hover{border-color:#2f425d}
    .item.active{border-color:rgba(255,122,24,.55);box-shadow:0 0 0 2px rgba(255,122,24,.08) inset;}
    .item .title{font-weight:900;font-size:13px;margin-bottom:6px;}
    .item .meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:11px;}
    .bar{height:8px;background:#0b0f14;border:1px solid var(--line);border-radius:999px;overflow:hidden;}
    .bar > div{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%;}
    .step{display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid var(--line);border-radius:14px;background:#0e1520;margin-top:8px;}
    .step input[type="checkbox"]{width:18px;height:18px;margin-top:2px;}
    .step .name{font-weight:900;font-size:12px;}
    .step .done{color:#bfe9ff;font-size:11px;margin-top:4px;}
    .toast{position:fixed;right:16px;bottom:16px;background:#0e1520;border:1px solid var(--line);padding:10px 12px;border-radius:12px;display:none;z-index:80;}

    .calHead{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px;}
    .calDow{font-size:11px;color:#cfe3ff;background:rgba(24,36,52,.6);border:1px solid var(--line);border-radius:12px;padding:8px;text-align:center;font-weight:900;}
    .calCell{min-height:120px;background:#0e1520;border:1px solid var(--line);border-radius:14px;padding:8px;display:flex;flex-direction:column;gap:6px;cursor:pointer;}
    .calCell:hover{border-color:#2f425d}
    .calCell.dim{opacity:.45}
    .calCell .dateRow{display:flex;gap:8px;align-items:center;}
    .calCell .dnum{font-weight:900;}
    .chip{display:flex;gap:6px;align-items:center;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:11px;background:#101a27;overflow:hidden}
    .chip.install{border-color:rgba(255,122,24,.55)}
    .chip.event{border-color:#5a4d1c}
    .chip.eventAll{border-color:#7a5b1c}
    .chip.bad{border-color:#7a2840}
    .chips{display:flex;flex-direction:column;gap:6px;overflow:hidden}

    .modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:70;}
    .modal{width:min(980px,96vw);max-height:90vh;overflow:auto;background:#0e1520;border:1px solid var(--line);border-radius:16px;padding:14px;}
    .modal h3{margin:0;font-size:14px;}
    .split{display:grid;gap:12px;}
    @media(min-width:900px){ .split{grid-template-columns:1fr 1fr;} }
    .small{font-size:11px}
    .warnTxt{color:var(--warn)}
    .badTxt{color:var(--bad)}
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .kpi .box{flex:1;min-width:150px;background:#0e1520;border:1px solid var(--line);border-radius:14px;padding:10px;}
    .box .n{font-size:18px;font-weight:900;}
    .box .t{font-size:11px;color:var(--muted);}
    pre{white-space:pre-wrap;word-break:break-word;}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row">
      <div>
        <h1>Provi/PM ‚Äì Circuit Tracker</h1>
        <div class="sub">Dashboard ‚Ä¢ Circuit Detail ‚Ä¢ Daily Log ‚Ä¢ Calendar ‚Ä¢ Sync ‡πÑ‡∏õ Google Drive (Apps Script)</div>
      </div>
      <div class="spacer"></div>

      <span class="pill" id="userPill">user: -</span>
      <span class="pill" id="dirtyPill">dirty: no</span>

      <button class="btn" id="btnSync">Sync now</button>
      <button class="btn danger" id="btnForce">Force sync</button>
      <button class="btn" id="btnOpenDrive">Open Drive</button>

      <a class="btn" href="index.html">Back</a>
    </div>
    <div class="row" style="margin-top:10px;">
      <span class="muted small mono" id="syncStatus">-</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid app">
    <!-- LEFT -->
    <aside class="card">
      <div class="row">
        <h2 style="margin:0;font-size:14px;">Circuits</h2>
        <div class="spacer"></div>
        <span class="pill" id="todayPill"></span>
      </div>

      <div class="kpi" id="kpi"></div>

      <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
      <input id="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ SOF / CID / ‡∏ä‡∏∑‡πà‡∏≠ / M" />

      <div class="row">
        <div style="flex:1;min-width:180px;">
          <label>‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
          <select id="filterType">
            <option value="ALL">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="DIA">DIA (CID ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô C)</option>
            <option value="DPLC">DPLC (CID ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô P)</option>
          </select>
        </div>
        <div style="flex:1;min-width:180px;">
          <label>‡πÄ‡∏£‡∏µ‡∏¢‡∏á</label>
          <select id="sortMode">
            <option value="lastUpdate">Last update ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
            <option value="percent">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏°‡∏≤‡∏Å‚Üí‡∏ô‡πâ‡∏≠‡∏¢</option>
            <option value="name">‡∏ä‡∏∑‡πà‡∏≠ A‚ÜíZ</option>
            <option value="created">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‚Üí‡∏´‡∏•‡∏±‡∏á</option>
          </select>
        </div>
      </div>

      <div id="circuitList" style="display:flex;flex-direction:column;gap:10px;margin-top:10px;"></div>
    </aside>

    <!-- RIGHT -->
    <section class="card">
      <div class="row">
        <h2 id="rightTitle" style="margin:0;font-size:14px;">Dashboard</h2>
        <div class="spacer"></div>
        <button class="btn" id="btnGoDashboard">Dashboard</button>
      </div>

      <div class="tabs">
        <button class="tab active" data-rtab="dashboard">Dashboard</button>
        <button class="tab" data-rtab="detail">Circuit Detail</button>
        <button class="tab" data-rtab="daily">Daily Log</button>
        <button class="tab" data-rtab="calendar">Calendar</button>
      </div>

      <!-- Dashboard -->
      <div id="rtab-dashboard" style="margin-top:10px;">
        <div class="row">
          <button class="btn primary" id="btnToggleAdd">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏á‡∏à‡∏£‡πÉ‡∏´‡∏°‡πà</button>
          <span class="muted small" id="addHint"></span>
          <div class="spacer"></div>
        </div>

        <div id="addPanel" class="card" style="display:none;background:#0e1520;border-color:var(--line);margin-top:10px;">
          <div class="row">
            <div style="font-weight:900;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏á‡∏à‡∏£‡πÉ‡∏´‡∏°‡πà</div>
            <div class="spacer"></div>
            <span class="muted small">Type auto ‡∏à‡∏≤‡∏Å CID ‚Ä¢ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ M ‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô M123 ‡∏´‡∏£‡∏∑‡∏≠ M123,M124</span>
          </div>
          <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr 1.2fr 1fr auto;margin-top:10px;">
            <div>
              <label style="margin-top:0;">SOF</label>
              <input id="addSof" placeholder="SOF" />
            </div>
            <div>
              <label style="margin-top:0;">CID</label>
              <input id="addCid" placeholder="CID (C... ‡∏´‡∏£‡∏∑‡∏≠ P...)" />
            </div>
            <div>
              <label style="margin-top:0;">‡∏ä‡∏∑‡πà‡∏≠</label>
              <input id="addName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô" />
            </div>
            <div>
              <label style="margin-top:0;">‡∏°‡∏µ M ‡πÑ‡∏´‡∏° (‡∏£‡∏∞‡∏ö‡∏∏ M)</label>
              <input id="addM" placeholder="‡πÄ‡∏ä‡πà‡∏ô M123 ‡∏´‡∏£‡∏∑‡∏≠ M123,M124" />
            </div>
            <div style="display:flex;align-items:flex-end;">
              <button class="btn primary" id="btnAddCircuit" style="width:120px;">Add</button>
            </div>
          </div>
        </div>

        <div style="display:grid;gap:12px;grid-template-columns:1fr 1fr;margin-top:12px;">
          <div>
            <label>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á (Log ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</label>
            <div style="max-height:340px;overflow:auto;border:1px solid var(--line);border-radius:14px;">
              <table>
                <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ß‡∏á‡∏à‡∏£/‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå</th><th>Action</th><th>Detail</th></tr></thead>
                <tbody id="todayLogTable"></tbody>
              </table>
            </div>
          </div>
          <div>
            <label>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (Progress / Next / Install / Remark)</label>
            <div style="max-height:340px;overflow:auto;border:1px solid var(--line);border-radius:14px;">
              <table>
                <thead><tr><th>‡∏ß‡∏á‡∏à‡∏£</th><th>%</th><th>Next</th><th>Install</th><th>Remark</th></tr></thead>
                <tbody id="overviewTable"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <label>Summary ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡πÄ‡∏ß‡πá‡∏ö)</label>
          <div style="max-height:520px;overflow:auto;border:1px solid var(--line);border-radius:14px;">
            <table>
              <thead>
                <tr><th>‡∏ß‡∏á‡∏à‡∏£</th><th>SOF</th><th>CID</th><th>Type</th><th>%</th><th>Last update</th><th>M</th><th>Install</th><th>Remark</th></tr>
              </thead>
              <tbody id="summaryTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Detail -->
      <div id="rtab-detail" style="display:none;margin-top:10px;">
        <div id="noSelected" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏á‡∏à‡∏£ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å list ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢)</div>

        <div id="detailPanel" style="display:none;">
          <div class="row" style="align-items:flex-start;">
            <div style="flex:1;">
              <div class="row">
                <span class="pill">Type: <b id="dType">-</b></span>
                <span class="pill">Progress: <b id="dPct">0%</b></span>
                <span class="pill">Last: <span class="mono" id="dLast">-</span></span>
                <span class="pill">Install: <span class="mono" id="dInstall">-</span></span>
              </div>
              <div style="margin-top:10px;" class="bar"><div id="dBar"></div></div>
            </div>
            <div><button class="btn danger" id="btnDelete">Delete</button></div>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn" id="btnToggleMeta">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏á‡∏à‡∏£ (SOF/CID/‡∏ä‡∏∑‡πà‡∏≠/M)</button>
            <span class="muted small" id="editHint"></span>
            <div class="spacer"></div>
          </div>
          <div id="metaPanel" class="card" style="display:none;background:#0e1520;border-color:var(--line);margin-top:10px;">
            <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr 1.2fr 1fr;">
              <div><label>SOF</label><input id="editSof" /></div>
              <div><label>CID</label><input id="editCid" /></div>
              <div><label>‡∏ä‡∏∑‡πà‡∏≠</label><input id="editName" /></div>
              <div><label>M (‡∏£‡∏∞‡∏ö‡∏∏ M ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input id="editM" /></div>
            </div>
            <div class="row" style="margin-top:10px;">
              <button class="btn primary" id="btnSaveMeta">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
              <div class="spacer"></div>
              <button class="btn" id="btnCloseMeta">Close</button>
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn" id="btnToggleInstall">üìå ‡∏ï‡∏±‡πâ‡∏á/‡πÅ‡∏Å‡πâ‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á (1 ‡∏ß‡∏á‡∏à‡∏£ 1 ‡∏ß‡∏±‡∏ô)</button>
            <span class="muted small" id="installHint"></span>
            <div class="spacer"></div>
          </div>
          <div id="installPanel" class="card" style="display:none;background:#0e1520;border-color:var(--line);margin-top:10px;">
            <div style="display:grid;gap:10px;grid-template-columns:240px 1fr auto;">
              <div>
                <label style="margin-top:0;">Install date</label>
                <input type="date" id="installDate" />
              </div>
              <div>
                <label style="margin-top:0;">Note (optional)</label>
                <input id="installNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô onsite / ‡∏ô‡∏±‡∏î‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤ / ‡∏Ñ‡∏∏‡∏°‡∏á‡∏≤‡∏ô" />
              </div>
              <div style="display:flex;align-items:flex-end;gap:10px;">
                <button class="btn primary" id="btnSaveInstall">Save</button>
                <button class="btn danger" id="btnClearInstall">Clear</button>
              </div>
            </div>
            <div class="muted small" style="margin-top:10px;">
              * ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏µ Personal event ‡πÅ‡∏ö‡∏ö ‚Äú‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô‚Äù ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á
            </div>
          </div>

          <label style="margin-top:14px;">Remark (‡∏ï‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£/‡∏£‡∏≠‡πÉ‡∏Ñ‡∏£)</label>
          <input id="remark" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠ IP / ‡∏£‡∏≠ WHA / ‡∏£‡∏≠‡∏Ç‡∏≠‡∏á" />
          <div class="row" style="margin-top:10px;">
            <button class="btn primary" id="btnSaveRemark">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Remark</button>
            <div class="spacer"></div>
            <span class="muted small">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏•‡∏á log ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ß‡∏•‡∏≤</span>
          </div>

          <div style="margin-top:12px;">
            <label>Log ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏á‡∏à‡∏£‡∏ô‡∏µ‡πâ</label>
            <div style="max-height:200px;overflow:auto;border:1px solid var(--line);border-radius:14px;padding:8px;background:#0e1520;">
              <div id="recentLog" class="small muted">-</div>
            </div>
          </div>

          <div style="margin-top:14px;">
            <h3 style="margin:0 0 6px 0;font-size:13px;">Checklist (21 ‡∏Ç‡∏±‡πâ‡∏ô)</h3>
            <div class="muted small">* Step 14 ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤ ‚Äú‡πÉ‡∏Å‡∏•‡πâ‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô 14‚Äù</div>
            <div id="steps"></div>
          </div>
        </div>
      </div>

      <!-- Daily -->
      <div id="rtab-daily" style="display:none;margin-top:10px;">
        <div class="row">
          <div style="flex:1;min-width:240px;">
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="logDate" />
          </div>
          <div style="flex:1;min-width:240px;">
            <label>‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏á‡∏à‡∏£</label>
            <select id="logCircuit"></select>
          </div>
        </div>

        <div style="margin-top:10px;max-height:620px;overflow:auto;border:1px solid var(--line);border-radius:14px;">
          <table>
            <thead>
              <tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>SOF</th><th>CID</th><th>Type</th><th>Action</th><th>Detail</th><th>Remark snapshot</th><th>M</th><th>Actor</th></tr>
            </thead>
            <tbody id="dailyBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Calendar -->
      <div id="rtab-calendar" style="display:none;margin-top:10px;">
        <div class="calHead">
          <button class="btn" id="calPrev">‚Äπ</button>
          <button class="btn" id="calToday">Today</button>
          <button class="btn" id="calNext">‚Ä∫</button>
          <span class="pill" id="calTitle"></span>
          <div class="spacer"></div>

          <div style="min-width:200px;">
            <select id="calFilter">
              <option value="ALL">All (DIA + DPLC)</option>
              <option value="DIA">DIA only</option>
              <option value="DPLC">DPLC only</option>
            </select>
          </div>
        </div>

        <div class="calGrid" id="calDowRow" style="margin-top:10px;"></div>
        <div class="calGrid" id="calGrid"></div>

        <div class="muted small" style="margin-top:10px;">
          ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° Install ‡∏´‡∏£‡∏∑‡∏≠ Personal event ‚Ä¢ ‡∏ñ‡πâ‡∏≤ ‚Äú‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô (ALL)‚Äù ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° Install ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
        </div>
      </div>

    </section>
  </div>
</main>

<!-- Calendar Day Modal -->
<div class="modalBackdrop" id="dayModalBack">
  <div class="modal">
    <div class="row">
      <h3 id="dayModalTitle">Day</h3>
      <div class="spacer"></div>
      <button class="btn" id="dayModalClose">Close</button>
    </div>

    <div class="split" style="margin-top:10px;">
      <!-- Install add -->
      <div class="card" style="background:#0b0f14;">
        <div class="row">
          <div style="font-weight:900;">Add install (‡∏ï‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ß‡∏á‡∏à‡∏£)</div>
          <div class="spacer"></div>
          <span class="muted small" id="dayInstallBlockHint"></span>
        </div>
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏á‡∏à‡∏£</label>
        <select id="dayInstallCircuit"></select>

        <label>Note (optional)</label>
        <input id="dayInstallNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô onsite / ‡∏ô‡∏±‡∏î‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤" />

        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="dayAddInstallBtn">Add</button>
          <div class="spacer"></div>
          <span class="muted small">‡∏ß‡∏á‡∏à‡∏£ 1 ‡∏ß‡∏á‡∏à‡∏£‡∏°‡∏µ 1 ‡∏ß‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏¢‡πâ‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÑ‡∏î‡πâ)</span>
        </div>

        <label style="margin-top:14px;">Install ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</label>
        <div style="max-height:260px;overflow:auto;border:1px solid var(--line);border-radius:14px;">
          <table>
            <thead><tr><th>‡∏ß‡∏á‡∏à‡∏£</th><th>Note</th><th>Move</th><th>Action</th></tr></thead>
            <tbody id="dayInstallList"></tbody>
          </table>
        </div>
      </div>

      <!-- Event add -->
      <div class="card" style="background:#0b0f14;">
        <div class="row">
          <div style="font-weight:900;">Add personal event</div>
          <div class="spacer"></div>
          <span class="muted small">‡πÄ‡∏ä‡πâ‡∏≤ / ‡∏ö‡πà‡∏≤‡∏¢ / ‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô</span>
        </div>

        <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr;">
          <div>
            <label>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
            <select id="dayEventSlot">
              <option value="AM">‡πÄ‡∏ä‡πâ‡∏≤ (AM)</option>
              <option value="PM">‡∏ö‡πà‡∏≤‡∏¢ (PM)</option>
              <option value="ALL">‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô (ALL)</option>
            </select>
          </div>
          <div>
            <label>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label>
            <input id="dayEventTitle" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏ö‡∏£‡∏° / ‡∏•‡∏≤ / ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô" />
          </div>
        </div>

        <label>Note (optional)</label>
        <input id="dayEventNote" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (optional)" />

        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="dayAddEventBtn">Add</button>
          <div class="spacer"></div>
          <span class="muted small" id="dayEventRuleHint"></span>
        </div>

        <label style="margin-top:14px;">Personal event ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</label>
        <div style="max-height:260px;overflow:auto;border:1px solid var(--line);border-radius:14px;">
          <table>
            <thead><tr><th>Slot</th><th>Title</th><th>Note</th><th>Del</th></tr></thead>
            <tbody id="dayEventList"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="muted small" style="margin-top:10px;">
      ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‚Äú‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô (ALL)‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πâ‡∏≤/‡∏ö‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° Install ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Ä¢
      ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏ä‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô) ‚Ä¢ ‡πÄ‡∏ä‡πâ‡∏≤/‡∏ö‡πà‡∏≤‡∏¢‡∏ã‡πâ‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Ä¢ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏ä‡πâ‡∏≤/‡∏ö‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  /** ===== CONFIG ===== */
  const API_URL = "https://script.google.com/macros/s/AKfycbwBHkVJ6TWyG0-pefvL1alAlB5RZVsix_g7kdM4TfGp_qiyKLll7lof5iZZfjASBy3pvg/exec";
  const ROOT_FOLDER_ID = "1sxBCtzxb7J_Hkw_9o_klPkQHHXLyMtIk";
  const AUTO_SYNC_MINUTES = 60;

  // ‚úÖ NEW: JSONP chunking
  const MAX_B64_CHUNK = 6500; // ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö URL ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà (‡∏£‡∏ß‡∏° callback/params ‡πÅ‡∏•‡πâ‡∏ß)

  const SESSION_KEY = "provi_session"; // {user,pass,ymLastSync}
  const DIRTY_KEY_PREFIX = "provi_dirty_"; // per-user
  const KEY_PREFIX = "provi_tracker_v3_";  // per-user

  // housekeeping keys
  const LAST_YM_KEY_PREFIX = "provi_lastYm_";      // per-user
  const MONTH_SUMMARY_KEY_PREFIX = "provi_monthSummary_"; // per-user (optional)
  const LAST_SYNC_AT_KEY_PREFIX = "provi_lastSyncAt_"; // ‚úÖ NEW (per-user)

  const $ = (id) => document.getElementById(id);

  /** ===== steps ===== */
  const STEPS = [
    "‡∏à‡∏≠‡∏á SID","‡∏™‡∏£‡πâ‡∏≤‡∏á SID ‡∏ö‡∏ô CMDB","‡∏™‡∏£‡πâ‡∏≤‡∏á Folder ‡πÑ‡∏î‡∏ü‡πå‡∏Å‡∏•‡∏≤‡∏á","‡πÄ‡∏õ‡∏¥‡∏î Task ‡πÑ‡∏õ‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á",
    "‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô/‡∏™‡∏£‡∏∏‡∏õ requirement ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö","‡πÄ‡∏ä‡πá‡∏Ñ stock / ‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á","‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° config ‡∏ï‡∏≤‡∏°‡∏ß‡∏á‡∏à‡∏£","‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°",
    "‡∏ó‡∏≥ 147","‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å Node","Shape Bandwidth","Add Zabbix + SMS Alert (‡∏ñ‡πâ‡∏≤ SOF ‡∏£‡∏∞‡∏ö‡∏∏)","Add Graph",
    "‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏ú‡∏ô‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á + ‡∏ô‡∏±‡∏î‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå","‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤","‡∏õ‡∏¥‡∏î SR","Update Inventory",
    "Update CMDB","Update CMDB (final check)","‡∏ó‡∏≥ F-108","‡∏õ‡∏¥‡∏î CR"
  ];
  const STEP_14_IDX = 13;

  /** ===== session / login ===== */
  function getSession(){
    try{ return JSON.parse(localStorage.getItem(SESSION_KEY) || "{}"); }catch{ return {}; }
  }
  function requireLogin(){
    const s = getSession();
    if(s.user && s.pass) return s;
    location.href = "index.html";
    return null;
  }
  const sess = requireLogin();
  if(!sess) return;

  const actor = sess.user;
  $("userPill").textContent = `user: ${actor}`;

  const KEY = KEY_PREFIX + actor;
  const DIRTY_KEY = DIRTY_KEY_PREFIX + actor;
  const LAST_YM_KEY = LAST_YM_KEY_PREFIX + actor;
  const MONTH_SUMMARY_KEY = MONTH_SUMMARY_KEY_PREFIX + actor;
  const LAST_SYNC_AT_KEY = LAST_SYNC_AT_KEY_PREFIX + actor;

  function getLastSyncAt(){ return Number(localStorage.getItem(LAST_SYNC_AT_KEY) || "0"); }
  function setLastSyncAt(ts){ localStorage.setItem(LAST_SYNC_AT_KEY, String(ts || Date.now())); }

  /** ===== state ===== */
  function load(){ try { return JSON.parse(localStorage.getItem(KEY)); } catch { return null; } }
  function save(silent=false){
    localStorage.setItem(KEY, JSON.stringify(state));
    setDirty(true);
    if(!silent) toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
  }
  const state = load() || { selectedId:null, circuits:{}, events:[], logs:{} };

  /** ===== helpers ===== */
  function toast(msg){
    const t=$("toast");
    t.textContent=msg;
    t.style.display="block";
    clearTimeout(toast._t);
    toast._t=setTimeout(()=>t.style.display="none",1400);
  }
  function uid(prefix="X"){ return prefix + Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function isoDate(d){
    const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function today(){ const d=new Date(); d.setHours(0,0,0,0); return d; }
  function todayStr(){ return isoDate(today()); }
  function nowTime(){
    const d=new Date(), hh=String(d.getHours()).padStart(2,"0"), mi=String(d.getMinutes()).padStart(2,"0"), ss=String(d.getSeconds()).padStart(2,"0");
    return `${hh}:${mi}:${ss}`;
  }
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }
  function inferTypeFromCID(cid){
    const c=(cid||"").trim().toUpperCase();
    if(c.startsWith("C")) return "DIA";
    if(c.startsWith("P")) return "DPLC";
    return "INVALID";
  }
  function ensureLogDate(date){ if(!state.logs[date]) state.logs[date]=[]; }
  function touchUpdate(c){ c.lastUpdateDate=todayStr(); c.lastUpdateTime=nowTime(); c.updatedAt=Date.now(); }
  function lastUpdateStamp(c){ return `${c.lastUpdateDate||"-"} ${c.lastUpdateTime||"-"}`; }

  // ‚úÖ PATCH: logId + createdAtMs
  function addLogCircuit(c, action, detail){
    const d=todayStr(), t=nowTime();
    ensureLogDate(d);
    state.logs[d].push({
      logId: uid("L"),
      createdAtMs: Date.now(),
      time:t, circuitId:c.id, sof:c.sof, cid:c.cid, type:c.type,
      action, detail,
      remarkSnapshot:(c.remark||"").trim(),
      mSnapshot:(c.m||"").trim(),
      actor
    });
  }
  function addLogSystem(action, detail){
    const d=todayStr(), t=nowTime();
    ensureLogDate(d);
    state.logs[d].push({
      logId: uid("L"),
      createdAtMs: Date.now(),
      time:t, circuitId:"", sof:"", cid:"", type:"",
      action, detail, remarkSnapshot:"", mSnapshot:"", actor
    });
  }

  function isStepDone(c, idx){ return !!(c.stepsDone && c.stepsDone[idx] && c.stepsDone[idx].done); }
  function percentOf(c){
    const doneCount = STEPS.reduce((a,_,i)=>a+(isStepDone(c,i)?1:0),0);
    return Math.round((doneCount/STEPS.length)*100);
  }
  function nextStepIndex(c){
    for(let i=0;i<STEPS.length;i++) if(!isStepDone(c,i)) return i;
    return null;
  }
  function isDoneCircuit(c){ return nextStepIndex(c)===null; }
  function getSelected(){ return state.selectedId ? state.circuits[state.selectedId] : null; }

  /** ===== dirty flag ===== */
  function isDirty(){ return localStorage.getItem(DIRTY_KEY)==="1"; }
  function setDirty(v){
    if(v) localStorage.setItem(DIRTY_KEY,"1");
    else localStorage.removeItem(DIRTY_KEY);
    $("dirtyPill").textContent = "dirty: " + (isDirty() ? "YES" : "no");
    $("dirtyPill").classList.toggle("warn", isDirty());
  }

  /** ===== Month helpers ===== */
  function ymNowLocal(){
    const d=new Date();
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,"0");
    return `${yyyy}-${mm}`;
  }
  function ymOfDateStr(d){ return String(d||"").slice(0,7); }
  function monthGuardAutoReset(){
    const nowYm = ymNowLocal();
    const lastYm = localStorage.getItem(LAST_YM_KEY) || "";
    if(lastYm && lastYm !== nowYm){
      state.logs = {};
      state.events = [];
      state.selectedId = null;
      localStorage.setItem(LAST_YM_KEY, nowYm);
      localStorage.removeItem(MONTH_SUMMARY_KEY);
      // ‚úÖ reset lastSyncAt ‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ delta ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
      localStorage.setItem(LAST_SYNC_AT_KEY, "0");
      save(true);
      toast(`‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß: reset logs/events (${lastYm} ‚Üí ${nowYm})`);
    }else if(!lastYm){
      localStorage.setItem(LAST_YM_KEY, nowYm);
    }
  }

  /** ===== Personal event rules ===== */
  function eventsOn(dateStr){ return (state.events||[]).filter(e=>e.date===dateStr); }
  function hasAllDay(dateStr){ return eventsOn(dateStr).some(e=>e.slot==="ALL"); }
  function hasSlot(dateStr, slot){ return eventsOn(dateStr).some(e=>e.slot===slot); }
  function canAddEvent(dateStr, slot){
    if(hasAllDay(dateStr)) return false;
    if(slot==="ALL") return eventsOn(dateStr).length===0;
    return !hasSlot(dateStr, slot);
  }
  function isInstallBlocked(dateStr){ return hasAllDay(dateStr); }

  /** ===== Base64 UTF-8 helpers (for chunking) ===== */
  function toB64Utf8(str){
    // btoa only supports latin1; convert utf8 safely
    return btoa(unescape(encodeURIComponent(str)));
  }

  /** ===== Sync payload builders ===== */
  function buildPayload({force=false}={}){
    const ym = ymNowLocal();
    const lastSyncAt = getLastSyncAt();

    // Work_Status: snapshot ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á ‡∏ì ‡∏ï‡∏≠‡∏ô sync
    const workStatus = Object.values(state.circuits||{})
      .filter(c=>!isDoneCircuit(c))
      .slice()
      .sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0))
      .map(c=>{
        const pct = percentOf(c);
        const nxt = nextStepIndex(c);
        return [
          ym,
          actor,
          c.cid||"",
          c.type||"",
          c.sof||"",
          c.name||"",
          pct,
          lastUpdateStamp(c),
          (nxt===null? "" : (nxt+1)),
          (nxt===null? "DONE" : STEPS[nxt]),
          c.installDate||"",
          (c.installNote||"").trim(),
          (c.remark||"").trim(),
          (c.m||"").trim()
        ];
      });

    // Logs: ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ + delta ‡∏´‡∏•‡∏±‡∏á lastSyncAt (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô force)
    const logs = [];
    Object.keys(state.logs||{}).sort().forEach(d=>{
      if(ymOfDateStr(d) !== ym) return;
      (state.logs[d]||[]).forEach(l=>{
        if(!force && (l.createdAtMs||0) <= lastSyncAt) return;
        const doneAt = `${d} ${l.time||""}`.trim();
        logs.push([
          ym,
          doneAt,
          l.actor||actor,
          l.action||"",
          l.sof||"",
          l.cid||"",
          l.type||"",
          "",
          "",
          l.detail||"",
          (l.remarkSnapshot||"").trim(),
          (l.mSnapshot||"").trim(),
          "",
          l.logId || ""
        ]);
      });
    });

    // Events: ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ + delta ‡∏´‡∏•‡∏±‡∏á lastSyncAt (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô force)
    const events = (state.events||[])
      .filter(e=>ymOfDateStr(e.date)===ym)
      .filter(e=> force ? true : ((e.createdAtMs||0) > lastSyncAt))
      .slice()
      .sort((a,b)=>(a.date||"").localeCompare(b.date||"") || (a.slot||"").localeCompare(b.slot||""))
      .map(e=>[
        ym,
        e.date||"",
        actor,
        e.slot||"",
        e.title||"",
        e.note||"",
        e.id||""
      ]);

    return { ym, actor, version:"tracker-v3-raw3", logs, events, workStatus };
  }

  /** ===== JSONP ===== */
  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(16).slice(2);
      const script = document.createElement("script");
      const timer = setTimeout(()=>{
        cleanup();
        reject(new Error("JSONP_TIMEOUT"));
      }, 20000);

      function cleanup(){
        clearTimeout(timer);
        try{ delete window[cb]; }catch(_){}
        if(script && script.parentNode) script.parentNode.removeChild(script);
      }

      window[cb] = (data)=>{ cleanup(); resolve(data); };
      script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
      script.onerror = ()=>{ cleanup(); reject(new Error("JSONP_ERROR")); };
      document.head.appendChild(script);
    });
  }

  /** ===== Chunked sync (fix JSONP_ERROR from long URL) ===== */
  async function sendPacketChunked(packet){
    // stringify -> base64 -> split
    const json = JSON.stringify(packet);
    const b64 = toB64Utf8(json);
    const packetId = uid("PKT");
    const total = Math.ceil(b64.length / MAX_B64_CHUNK);

    for(let i=0;i<total;i++){
      const chunk = b64.slice(i*MAX_B64_CHUNK, (i+1)*MAX_B64_CHUNK);
      const url =
        API_URL +
        `?mode=syncChunk` +
        `&packetId=${encodeURIComponent(packetId)}` +
        `&chunkIndex=${i}` +
        `&chunkTotal=${total}` +
        `&chunk=${encodeURIComponent(chunk)}`;

      $("syncStatus").textContent = `Sending chunk ${i+1}/${total}...`;
      const res = await jsonp(url);

      if(!res || res.ok !== true){
        throw new Error((res && res.error) ? res.error : "CHUNK_FAILED");
      }

      // chunk ack; final response will have final:true
      if(res.final === true){
        return res;
      }
    }
    // ‡∏ñ‡πâ‡∏≤‡∏´‡∏•‡∏∏‡∏î‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡∏ô‡∏µ‡πà ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ final
    throw new Error("NO_FINAL_RESPONSE");
  }

function b64UrlEncodeUtf8(str){
  const b64 = btoa(unescape(encodeURIComponent(str)));
  return b64.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}
function jsonpGet(paramsObj){
  const qs = Object.keys(paramsObj)
    .map(k => `${encodeURIComponent(k)}=${encodeURIComponent(paramsObj[k])}`)
    .join("&");
  return jsonp(API_URL + "?" + qs);
}
function chunkRows(rows, perBatch){
  const out=[];
  for(let i=0;i<rows.length;i+=perBatch) out.push(rows.slice(i,i+perBatch));
  return out;
}

async function sendToScriptVerified({force=false}={}){
  if(!force && !isDirty()){
    $("syncStatus").textContent = "Skip: not dirty";
    return;
  }

  const payload = buildPayload();
  const ym = payload.ym;

  try{
    $("syncStatus").textContent = "Init sync ...";

    // 1) INIT
    const initRes = await jsonpGet({
      mode: "syncInit",
      user: sess.user,
      pass: sess.pass,
      ym
    });
    if(!initRes || initRes.ok !== true || !initRes.syncId){
      throw new Error((initRes && initRes.error) ? initRes.error : "INIT_FAIL");
    }
    const syncId = initRes.syncId;

    // 2) WORK_STATUS (‡∏™‡πà‡∏á‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
    $("syncStatus").textContent = "Sending Work_Status ...";
    {
      const pack = { rows: payload.workStatus };
      const res = await jsonpGet({
        mode:"syncBatch",
        syncId,
        part:"work",
        data: b64UrlEncodeUtf8(JSON.stringify(pack))
      });
      if(!res || res.ok !== true) throw new Error(res && res.error ? res.error : "WORK_FAIL");
    }

    // 3) LOGS (‡πÅ‡∏ö‡πà‡∏á‡πÅ‡∏ö‡∏ï‡∏ä‡πå)
    const logBatches = chunkRows(payload.logs, 20); // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏õ‡∏£‡∏±‡∏ö 30
    for(let i=0;i<logBatches.length;i++){
      $("syncStatus").textContent = `Sending logs ${i+1}/${logBatches.length} ...`;
      const pack = { rows: logBatches[i] };
      const res = await jsonpGet({
        mode:"syncBatch",
        syncId,
        part:"logs",
        data: b64UrlEncodeUtf8(JSON.stringify(pack))
      });
      if(!res || res.ok !== true) throw new Error(res && res.error ? res.error : "LOGS_FAIL");
    }

    // 4) EVENTS
    const eventBatches = chunkRows(payload.events, 30);
    for(let i=0;i<eventBatches.length;i++){
      $("syncStatus").textContent = `Sending events ${i+1}/${eventBatches.length} ...`;
      const pack = { rows: eventBatches[i] };
      const res = await jsonpGet({
        mode:"syncBatch",
        syncId,
        part:"events",
        data: b64UrlEncodeUtf8(JSON.stringify(pack))
      });
      if(!res || res.ok !== true) throw new Error(res && res.error ? res.error : "EVENTS_FAIL");
    }

    // 5) FINISH
    $("syncStatus").textContent = "Finishing ...";
    const finRes = await jsonpGet({ mode:"syncFinish", syncId });
    if(!finRes || finRes.ok !== true) throw new Error(finRes && finRes.error ? finRes.error : "FINISH_FAIL");
    setLastSyncAt(Date.now());

    // ‚úÖ clean local (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const before = Object.keys(state.circuits||{}).length;
    for(const id of Object.keys(state.circuits||{})){
      const c = state.circuits[id];
      if(c && isDoneCircuit(c)) delete state.circuits[id];
    }
    const after = Object.keys(state.circuits||{}).length;

    state.logs = {};
    state.selectedId = null;
    save(true);

    setDirty(false);
    $("syncStatus").textContent = `Sent ‚úÖ (${ym}) ‚Äî batch sync OK (done:${before-after})`;
    toast(`Sync ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à + clean ‡πÅ‡∏•‡πâ‡∏ß (‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à ${before-after})`);
    renderAll(true);

  }catch(e){
    $("syncStatus").textContent = "Sync failed: " + (e.message || e);
    toast("Sync ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }
}
  function startAutoSync(){
    setInterval(async ()=>{
      try{
        monthGuardAutoReset();
        if(!isDirty()) return;
        await sendToScriptVerified({force:false});
      }catch(_){}
    }, AUTO_SYNC_MINUTES*60*1000);
  }

  /** ===== UI: tabs ===== */
  const tabsRight=[...document.querySelectorAll(".tab[data-rtab]")];
  const rDash=$("rtab-dashboard"), rDetail=$("rtab-detail"), rDaily=$("rtab-daily"), rCal=$("rtab-calendar");
  function switchRightTab(name){
    tabsRight.forEach(x=>x.classList.toggle("active", x.dataset.rtab===name));
    rDash.style.display = name==="dashboard" ? "" : "none";
    rDetail.style.display = name==="detail" ? "" : "none";
    rDaily.style.display = name==="daily" ? "" : "none";
    rCal.style.display = name==="calendar" ? "" : "none";
    $("rightTitle").textContent = name==="dashboard" ? "Dashboard" : name==="detail" ? "Circuit Detail" : name==="daily" ? "Daily Log" : "Calendar";
    renderAll(true);
  }

  /** ===== init static UI ===== */
  $("todayPill").textContent = `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ${todayStr()}`;
  $("logDate").value = todayStr();
  const dows = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  $("calDowRow").innerHTML = dows.map(d=>`<div class="calDow">${d}</div>`).join("");

  /** ===== events bindings ===== */
  tabsRight.forEach(b=> b.addEventListener("click", ()=> switchRightTab(b.dataset.rtab)));
  $("btnGoDashboard").addEventListener("click", ()=> switchRightTab("dashboard"));

  $("search").addEventListener("input", renderCircuitList);
  $("filterType").addEventListener("change", renderCircuitList);
  $("sortMode").addEventListener("change", renderCircuitList);

  $("btnToggleAdd").addEventListener("click", ()=>{
    const p=$("addPanel");
    p.style.display = (p.style.display==="none") ? "" : "none";
  });

  $("addCid").addEventListener("input", ()=>{
    const t=inferTypeFromCID($("addCid").value);
    $("addHint").textContent = t==="INVALID" ? "CID ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô C ‡∏´‡∏£‡∏∑‡∏≠ P" : `Type (auto): ${t}`;
  });

  $("btnAddCircuit").addEventListener("click", ()=>{
    const sof=($("addSof").value||"").trim();
    const cid=($("addCid").value||"").trim();
    const name=($("addName").value||"").trim();
    const m=($("addM").value||"").trim();
    if(!sof||!cid||!name){ toast("‡∏Å‡∏£‡∏≠‡∏Å SOF, CID, ‡∏ä‡∏∑‡πà‡∏≠ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); return; }
    const type=inferTypeFromCID(cid);
    if(type==="INVALID"){ toast("CID ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô C ‡∏´‡∏£‡∏∑‡∏≠ P"); return; }

    const id=uid("C");
    const c={
      id, sof, cid, name, type, m,
      remark:"",
      createdAt: todayStr(),
      lastUpdateDate: todayStr(),
      lastUpdateTime: nowTime(),
      stepsDone:{},
      installDate:"",
      installNote:"",
      updatedAt: Date.now()
    };
    state.circuits[id]=c;
    state.selectedId=id;
    addLogCircuit(c,"CIRCUIT_CREATE","‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏á‡∏à‡∏£‡πÉ‡∏´‡∏°‡πà");
    save(true);

    $("addSof").value=""; $("addCid").value=""; $("addName").value=""; $("addM").value="";
    $("addPanel").style.display="none";
    $("addHint").textContent = `‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß: ${c.type} ‚Ä¢ ${c.cid} ‚Ä¢ ${c.name}`;
    toast("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏á‡∏à‡∏£‡πÅ‡∏•‡πâ‡∏ß");
    switchRightTab("detail");
  });

  $("btnToggleMeta").addEventListener("click", ()=>{
    const p=$("metaPanel");
    p.style.display = (p.style.display==="none") ? "" : "none";
  });
  $("btnCloseMeta").addEventListener("click", ()=> $("metaPanel").style.display="none");

  $("btnToggleInstall").addEventListener("click", ()=>{
    const p=$("installPanel");
    p.style.display = (p.style.display==="none") ? "" : "none";
  });

  $("btnSaveMeta").addEventListener("click", ()=>{
    const c=getSelected(); if(!c) return;
    const sof=($("editSof").value||"").trim();
    const cid=($("editCid").value||"").trim();
    const name=($("editName").value||"").trim();
    const m=($("editM").value||"").trim();
    if(!sof||!cid||!name){ toast("‡∏Å‡∏£‡∏≠‡∏Å SOF, CID, ‡∏ä‡∏∑‡πà‡∏≠ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); return; }
    const type=inferTypeFromCID(cid);
    if(type==="INVALID"){ toast("CID ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô C ‡∏´‡∏£‡∏∑‡∏≠ P"); return; }

    c.sof=sof; c.cid=cid; c.name=name; c.type=type; c.m=m;
    touchUpdate(c);
    addLogCircuit(c,"CIRCUIT_EDIT","‡πÅ‡∏Å‡πâ SOF/CID/‡∏ä‡∏∑‡πà‡∏≠/M");
    save(true);
    toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
    $("metaPanel").style.display="none";
    renderAll(true);
  });

  $("btnSaveInstall").addEventListener("click", ()=>{
    const c=getSelected(); if(!c) return;
    const d = $("installDate").value || "";
    const note = ($("installNote").value||"").trim();

    if(d && isInstallBlocked(d)){
      toast("‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô Full day event ‡∏≠‡∏¢‡∏π‡πà ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô");
      return;
    }

    const prev = c.installDate || "";
    c.installDate = d;
    c.installNote = note;

    touchUpdate(c);
    if(!prev && d) addLogCircuit(c,"INSTALL_SET",`‡∏ï‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ${d}${note?` (${note})`:``}`);
    else if(prev && d && prev!==d) addLogCircuit(c,"INSTALL_CHANGE",`‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ${prev} ‚Üí ${d}${note?` (${note})`:``}`);
    else if(prev && !d) addLogCircuit(c,"INSTALL_CLEAR",`‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á (‡πÄ‡∏î‡∏¥‡∏° ${prev})`);
    else addLogCircuit(c,"INSTALL_UPDATE_NOTE",`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï note ‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ${d || "(none)"}`);

    save(true);
    toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
    $("installPanel").style.display="none";
    renderAll(true);
  });

  $("btnClearInstall").addEventListener("click", ()=>{
    const c=getSelected(); if(!c) return;
    if(!c.installDate){ toast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á"); return; }
    const prev=c.installDate;
    c.installDate=""; c.installNote="";
    touchUpdate(c);
    addLogCircuit(c,"INSTALL_CLEAR",`‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á (‡πÄ‡∏î‡∏¥‡∏° ${prev})`);
    save(true);
    toast("‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
    $("installPanel").style.display="none";
    renderAll(true);
  });

  $("btnSaveRemark").addEventListener("click", ()=>{
    const c=getSelected(); if(!c) return;
    c.remark = ($("remark").value||"").trim();
    touchUpdate(c);
    addLogCircuit(c,"REMARK_UPDATE","‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Remark");
    save(true);
    toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Remark ‡πÅ‡∏•‡πâ‡∏ß");
    renderAll(true);
  });

  $("btnDelete").addEventListener("click", ()=>{
    const c=getSelected(); if(!c) return;
    if(!confirm(`‡∏•‡∏ö‡∏ß‡∏á‡∏à‡∏£‡∏ô‡∏µ‡πâ?\nSOF:${c.sof}\nCID:${c.cid}\n‡∏ä‡∏∑‡πà‡∏≠:${c.name}`)) return;
    addLogCircuit(c,"CIRCUIT_DELETE","‡∏•‡∏ö‡∏ß‡∏á‡∏à‡∏£");
    delete state.circuits[c.id];
    state.selectedId=null;
    save(true);
    toast("‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
    switchRightTab("dashboard");
  });

  $("logDate").addEventListener("change", renderDaily);
  $("logCircuit").addEventListener("change", renderDaily);

  /** ===== Calendar navigation ===== */
  let calView = new Date(); calView.setDate(1);
  $("calPrev").addEventListener("click", ()=>{ calView.setMonth(calView.getMonth()-1); calView.setDate(1); renderCalendar(); });
  $("calNext").addEventListener("click", ()=>{ calView.setMonth(calView.getMonth()+1); calView.setDate(1); renderCalendar(); });
  $("calToday").addEventListener("click", ()=>{ calView=new Date(); calView.setDate(1); renderCalendar(); });
  $("calFilter").addEventListener("change", renderCalendar);

  /** ===== modal controls ===== */
  const modalBack = $("dayModalBack");
  $("dayModalClose").addEventListener("click", closeDayModal);
  modalBack.addEventListener("click", (e)=>{ if(e.target===modalBack) closeDayModal(); });
  let modalDay = null;

  $("dayAddInstallBtn").addEventListener("click", ()=>{
    if(!modalDay) return;
    if(isInstallBlocked(modalDay)){
      toast("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Full day event ‡∏≠‡∏¢‡∏π‡πà ‡πÄ‡∏û‡∏¥‡πà‡∏° Install ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
      return;
    }
    const circuitId = $("dayInstallCircuit").value;
    const note = ($("dayInstallNote").value||"").trim();
    const c = state.circuits[circuitId];
    if(!c){ toast("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏á‡∏à‡∏£"); return; }

    if(c.installDate && c.installDate !== modalDay){
      const ok = confirm(`‡∏ß‡∏á‡∏à‡∏£‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß: ${c.installDate}\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ: ${modalDay} ?`);
      if(!ok) return;
    }

    const prev = c.installDate || "";
    c.installDate = modalDay;
    c.installNote = note;

    touchUpdate(c);
    if(!prev) addLogCircuit(c,"INSTALL_SET",`‡∏ï‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ${modalDay}${note?` (${note})`:``}`);
    else if(prev !== modalDay) addLogCircuit(c,"INSTALL_CHANGE",`‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ${prev} ‚Üí ${modalDay}${note?` (${note})`:``}`);
    else addLogCircuit(c,"INSTALL_UPDATE_NOTE",`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï note ‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ${modalDay}${note?` (${note})`:``}`);

    save(true);
    $("dayInstallNote").value="";
    toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
    renderAll(true);
    renderDayModal();
  });

  $("dayAddEventBtn").addEventListener("click", ()=>{
    if(!modalDay) return;
    const slot = $("dayEventSlot").value;
    const title = ($("dayEventTitle").value||"").trim();
    const note = ($("dayEventNote").value||"").trim();
    if(!title){ toast("‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠"); return; }

    if(!canAddEvent(modalDay, slot)){
      toast("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏ä‡∏ô‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤: ‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô/‡∏ã‡πâ‡∏≥ slot/‡∏°‡∏µ‡πÄ‡∏ä‡πâ‡∏≤-‡∏ö‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô)");
      return;
    }

    // ‚úÖ PATCH: createdAtMs
    const ev = { id: uid("E"), date: modalDay, slot, title, note, createdAtMs: Date.now() };
    state.events.push(ev);
    addLogSystem("EVENT_ADD", `${modalDay} ${slot} ${title}${note?` (${note})`:``}`);
    save(true);

    $("dayEventTitle").value=""; $("dayEventNote").value="";
    toast("‡πÄ‡∏û‡∏¥‡πà‡∏° event ‡πÅ‡∏•‡πâ‡∏ß");
    renderAll(true);
    renderDayModal();
  });

  /** ===== Header actions ===== */
  $("btnSync").addEventListener("click", ()=>sendToScriptVerified({force:false}));
  $("btnForce").addEventListener("click", ()=>sendToScriptVerified({force:true}));
  $("btnOpenDrive").addEventListener("click", ()=>{ window.open(`https://drive.google.com/drive/folders/${ROOT_FOLDER_ID}`, "_blank"); });

  /** ===== render ===== */
  function renderAll(){
    setDirty(isDirty());
    renderKpi();
    renderCircuitList();
    renderDashboard();
    renderDetail();
    renderDailyCircuitOptions();
    renderDaily();
    renderCalendar();
  }

  function renderKpi(){
    const circuits=Object.values(state.circuits);
    const total=circuits.length;
    const dia=circuits.filter(c=>c.type==="DIA").length;
    const dplc=circuits.filter(c=>c.type==="DPLC").length;
    const avg=total?Math.round(circuits.reduce((a,c)=>a+percentOf(c),0)/total):0;
    const hasRemark=circuits.filter(c=>(c.remark||"").trim().length>0 && percentOf(c)<100).length;
    $("kpi").innerHTML = `
      <div class="box"><div class="n">${total}</div><div class="t">‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á (‡πÉ‡∏ô‡πÄ‡∏ß‡πá‡∏ö)</div></div>
      <div class="box"><div class="n">${dia}</div><div class="t">DIA</div></div>
      <div class="box"><div class="n">${dplc}</div><div class="t">DPLC</div></div>
      <div class="box"><div class="n">${avg}%</div><div class="t">Avg progress</div></div>
      <div class="box"><div class="n">${hasRemark}</div><div class="t">‡∏°‡∏µ Remark/‡∏ï‡∏¥‡∏î</div></div>
    `;
  }

  function renderCircuitList(){
    const q = ($("search").value||"").toLowerCase().trim();
    const ft = $("filterType").value;
    let list = Object.values(state.circuits);

    if(ft!=="ALL") list=list.filter(c=>c.type===ft);
    if(q) list=list.filter(c=>[c.sof,c.cid,c.name,c.m].some(v=>(v||"").toLowerCase().includes(q)));

    const mode=$("sortMode").value;
    list.sort((a,b)=>{
      if(mode==="lastUpdate") return (b.updatedAt||0)-(a.updatedAt||0);
      if(mode==="percent") return percentOf(b)-percentOf(a);
      if(mode==="name") return (a.name||"").localeCompare(b.name||"");
      if(mode==="created") return (a.createdAt||"").localeCompare(b.createdAt||"");
      return 0;
    });

    $("circuitList").innerHTML = list.map(c=>{
      const pct=percentOf(c);
      const nxt=nextStepIndex(c);
      const nxtText=nxt===null?"‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á sync)":"‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: " + `${nxt+1}. ${STEPS[nxt]}`;
      const remark=(c.remark||"").trim();
      const m=(c.m||"").trim();
      const installTxt = c.installDate ? c.installDate : "-";
      const blocked = c.installDate && isInstallBlocked(c.installDate) ? " ‚ö†(Full day)" : "";
      const active = state.selectedId===c.id ? "active" : "";
      return `
        <div class="item ${active}" data-id="${c.id}">
          <div class="title">${escapeHtml(c.name)}</div>
          <div class="meta">
            <span class="pill">${c.type}</span>
            <span class="pill">SOF: <span class="mono">${escapeHtml(c.sof)}</span></span>
            <span class="pill">CID: <span class="mono">${escapeHtml(c.cid)}</span></span>
            ${m?`<span class="pill">M: <span class="mono">${escapeHtml(m)}</span></span>`:""}
          </div>
          <div style="margin-top:8px;" class="bar"><div style="width:${pct}%"></div></div>
          <div class="muted small" style="margin-top:8px;">
            <b class="mono">${pct}%</b> ‚Ä¢ ${escapeHtml(nxtText)}
            <div class="muted small">Install: <span class="mono">${escapeHtml(installTxt)}</span>${blocked?`<span class="badTxt">${blocked}</span>`:""}</div>
            ${remark?`<div class="muted small"><span class="warnTxt">Remark:</span> ${escapeHtml(remark)}</div>`:""}
            <div class="muted small">Last: <span class="mono">${escapeHtml(lastUpdateStamp(c))}</span></div>
          </div>
        </div>
      `;
    }).join("") || `<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</div>`;

    $("circuitList").querySelectorAll(".item").forEach(el=>{
      el.addEventListener("click", ()=>{
        state.selectedId = el.dataset.id;
        save(true);
        switchRightTab("detail");
      });
    });
  }

  function renderDashboard(){
    const d=todayStr(); ensureLogDate(d);
    const logs=(state.logs[d]||[]).slice().reverse();
    $("todayLogTable").innerHTML = logs.map(l=>{
      const isSys = !l.circuitId;
      const c = l.circuitId ? state.circuits[l.circuitId] : null;
      const name = c ? c.name : (isSys ? "SYSTEM" : "(deleted)");
      const meta = c ? `${c.sof} ‚Ä¢ ${c.cid} ‚Ä¢ ${c.type}` : "";
      return `
        <tr>
          <td class="mono">${escapeHtml(l.time)}</td>
          <td><b>${escapeHtml(name)}</b>${meta?`<div class="muted small">${escapeHtml(meta)}</div>`:""}</td>
          <td class="mono">${escapeHtml(l.action)}</td>
          <td>${escapeHtml(l.detail||"")}</td>
        </tr>
      `;
    }).join("") || `<tr><td colspan="4" class="muted">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ log</td></tr>`;

    const circuits=Object.values(state.circuits).slice().sort((a,b)=>percentOf(b)-percentOf(a));
    $("overviewTable").innerHTML = circuits.slice(0,18).map(c=>{
      const pct=percentOf(c);
      const nxt=nextStepIndex(c);
      const nxtText=nxt===null?"DONE":`${nxt+1}. ${STEPS[nxt]}`;
      const remark=(c.remark||"").trim();
      const install = c.installDate ? c.installDate : "-";
      return `
        <tr>
          <td><b>${escapeHtml(c.name)}</b><div class="muted small">${escapeHtml(c.type)} ‚Ä¢ ${escapeHtml(c.cid)}${(c.m||"").trim()?` ‚Ä¢ M:${escapeHtml((c.m||"").trim())}`:""}</div></td>
          <td class="mono">${pct}%</td>
          <td>${escapeHtml(nxtText)}</td>
          <td class="mono">${escapeHtml(install)}</td>
          <td>${remark?escapeHtml(remark):"<span class='muted'>-</span>"}</td>
        </tr>
      `;
    }).join("") || `<tr><td colspan="5" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</td></tr>`;

    $("summaryTable").innerHTML = Object.values(state.circuits)
      .slice()
      .sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0))
      .map(c=>{
        const pct=percentOf(c);
        const remark=(c.remark||"").trim();
        const m=(c.m||"").trim();
        const install=c.installDate || "";
        return `
          <tr>
            <td><b>${escapeHtml(c.name)}</b></td>
            <td class="mono">${escapeHtml(c.sof)}</td>
            <td class="mono">${escapeHtml(c.cid)}</td>
            <td>${escapeHtml(c.type)}</td>
            <td class="mono">${pct}%</td>
            <td class="mono">${escapeHtml(lastUpdateStamp(c))}</td>
            <td class="mono">${m?escapeHtml(m):"<span class='muted'>-</span>"}</td>
            <td class="mono">${install?escapeHtml(install):"<span class='muted'>-</span>"}</td>
            <td>${remark?escapeHtml(remark):"<span class='muted'>-</span>"}</td>
          </tr>
        `;
      }).join("") || `<tr><td colspan="9" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</td></tr>`;
  }

  function renderDetail(){
    const c=getSelected();
    if(!c){
      $("noSelected").style.display="";
      $("detailPanel").style.display="none";
      return;
    }
    $("noSelected").style.display="none";
    $("detailPanel").style.display="";

    const pct=percentOf(c);
    $("dType").textContent=c.type;
    $("dPct").textContent=`${pct}%`;
    $("dLast").textContent=lastUpdateStamp(c);
    $("dBar").style.width=`${pct}%`;
    $("dInstall").textContent = c.installDate ? c.installDate : "-";

    $("editSof").value=c.sof||"";
    $("editCid").value=c.cid||"";
    $("editName").value=c.name||"";
    $("editM").value=c.m||"";
    $("remark").value=c.remark||"";

    $("installDate").value = c.installDate || "";
    $("installNote").value = c.installNote || "";

    $("editHint").textContent = `Type auto ‡∏à‡∏≤‡∏Å CID: ${inferTypeFromCID(c.cid)}`;
    $("installHint").textContent = c.installDate
      ? (isInstallBlocked(c.installDate) ? "‚ö† ‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏ô Full day event (‡∏Ñ‡∏ß‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô)" : "‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ)")
      : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á";

    const recent=[];
    for(const d of Object.keys(state.logs).sort().reverse()){
      const arr=state.logs[d]||[];
      for(let i=arr.length-1;i>=0;i--){
        const l=arr[i];
        if(l.circuitId===c.id){
          recent.push({date:d,...l});
          if(recent.length>=12) break;
        }
      }
      if(recent.length>=12) break;
    }
    $("recentLog").innerHTML = recent.length ? recent.map(r=>{
      return `<div>‚Ä¢ <span class="mono">${escapeHtml(r.date)} ${escapeHtml(r.time)}</span> ‚Äî <span class="mono">${escapeHtml(r.action)}</span> ${escapeHtml(r.detail||"")} <span class="muted small">(${escapeHtml(r.actor||"")})</span></div>`;
    }).join("") : `<span class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ log</span>`;

    $("steps").innerHTML = STEPS.map((name, idx)=>{
      const done=isStepDone(c,idx);
      const date=done?(c.stepsDone[idx].date||"-"):"";
      const tag = idx===STEP_14_IDX ? `<span class="pill warn">‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Alerts</span>` : "";
      return `
        <div class="step">
          <input type="checkbox" data-step="${idx}" ${done?"checked":""} />
          <div style="flex:1;">
            <div class="name">${idx+1}. ${escapeHtml(name)} ${tag}</div>
            ${done?`<div class="done">‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span class="mono">${escapeHtml(date)}</span></div>`:`<div class="done muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥</div>`}
          </div>
        </div>
      `;
    }).join("");

    $("steps").querySelectorAll("input[type=checkbox][data-step]").forEach(cb=>{
      cb.addEventListener("change", ()=>{
        const idx=Number(cb.dataset.step);
        toggleStep(c.id, idx, cb.checked);
      });
    });
  }

  function toggleStep(id, idx, checked){
    const c=state.circuits[id]; if(!c) return;
    if(!c.stepsDone) c.stepsDone={};
    if(!c.stepsDone[idx]) c.stepsDone[idx]={done:false,date:""};
    c.stepsDone[idx].done=checked;
    c.stepsDone[idx].date=checked?todayStr():"";
    touchUpdate(c);
    addLogCircuit(c, checked?"STEP_CHECK":"STEP_UNCHECK", `${idx+1}. ${STEPS[idx]}`);
    save(true);
    toast(checked?"‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏° + ‡∏•‡∏á log ‡πÅ‡∏•‡πâ‡∏ß":"‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏¥‡πä‡∏Å + ‡∏•‡∏á log ‡πÅ‡∏•‡πâ‡∏ß");
    renderAll(true);
  }

  function renderDailyCircuitOptions(){
    const sel=$("logCircuit");
    const list=Object.values(state.circuits).slice().sort((a,b)=>(a.name||"").localeCompare(b.name||""));
    sel.innerHTML = `<option value="">(‡∏ó‡∏∏‡∏Å‡∏ß‡∏á‡∏à‡∏£ + system)</option>` + list.map(c=>`<option value="${c.id}">${escapeHtml(c.name)} ‚Ä¢ ${escapeHtml(c.cid)}</option>`).join("");
  }

  function renderDaily(){
    const d=$("logDate").value||todayStr();
    ensureLogDate(d);
    const id=$("logCircuit").value||"";
    const logs=(state.logs[d]||[]).filter(l=>!id || l.circuitId===id).slice().reverse();

    $("dailyBody").innerHTML = logs.map(l=>{
      const c=l.circuitId ? state.circuits[l.circuitId] : null;
      const m=c?(c.m||""):(l.mSnapshot||"");
      return `
        <tr>
          <td class="mono">${escapeHtml(l.time)}</td>
          <td class="mono">${escapeHtml(l.sof||"")}</td>
          <td class="mono">${escapeHtml(l.cid||"")}</td>
          <td>${escapeHtml(l.type||"")}</td>
          <td class="mono">${escapeHtml(l.action||"")}</td>
          <td>${escapeHtml(l.detail||"")}</td>
          <td>${(l.remarkSnapshot||"").trim()?escapeHtml(l.remarkSnapshot):"<span class='muted'>-</span>"}</td>
          <td>${m?`<span class="mono">${escapeHtml(m)}</span>`:"<span class='muted'>-</span>"}</td>
          <td>${escapeHtml(l.actor||"")}</td>
        </tr>
      `;
    }).join("") || `<tr><td colspan="9" class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ log ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>`;
  }

  /** ===== Calendar render + modal ===== */
  function monthName(d){ return d.toLocaleString("en-US",{month:"long", year:"numeric"}); }

  function renderCalendar(){
    $("calTitle").textContent = monthName(calView);
    const y=calView.getFullYear(), m=calView.getMonth();
    const first = new Date(y,m,1); first.setHours(0,0,0,0);
    const last = new Date(y,m+1,0); last.setHours(0,0,0,0);

    const firstDow = (first.getDay()+6)%7; // Mon=0
    const totalDays = last.getDate();
    const cells = [];
    for(let i=0;i<firstDow;i++){
      const d = new Date(y,m,1-(firstDow-i));
      cells.push({date: d, inMonth:false});
    }
    for(let d=1; d<=totalDays; d++) cells.push({date: new Date(y,m,d), inMonth:true});
    while(cells.length%7!==0){
      const d = new Date(y,m,totalDays + (cells.length - (firstDow+totalDays)) + 1);
      cells.push({date: d, inMonth:false});
    }

    const filter = $("calFilter").value;

    $("calGrid").innerHTML = cells.map(cell=>{
      const ds = isoDate(cell.date);
      const dim = cell.inMonth ? "" : "dim";
      const dayNum = cell.date.getDate();
      const todayMark = (ds===todayStr()) ? `<span class="pill good">today</span>` : "";

      const evs = eventsOn(ds).slice().sort((a,b)=>a.slot.localeCompare(b.slot));
      const allDay = evs.some(e=>e.slot==="ALL");

      const eventChips = evs.slice(0,4).map(e=>{
        const cls = e.slot==="ALL" ? "eventAll" : "event";
        return `<div class="chip ${cls}"><span class="mono">${escapeHtml(e.slot)}</span><span>${escapeHtml(e.title)}</span></div>`;
      });

      const installs = Object.values(state.circuits)
        .filter(c=>{
          if(filter!=="ALL" && c.type!==filter) return false;
          return c.installDate===ds;
        })
        .sort((a,b)=>(a.cid||"").localeCompare(b.cid||""))
        .slice(0,4)
        .map(c=>{
          const step14 = isStepDone(c, STEP_14_IDX);
          const cls = step14 ? "install" : "install bad";
          const warn = step14 ? "" : `<span class="mono badTxt">‚ö†</span>`;
          return `<div class="chip ${cls}">${warn}<span class="mono">${escapeHtml(c.cid)}</span><span>${escapeHtml(c.name)}</span></div>`;
        });

      const allBadge = allDay ? `<span class="pill warn">FULL</span>` : "";

      return `
        <div class="calCell ${dim}" data-day="${ds}">
          <div class="dateRow">
            <div class="dnum">${dayNum}</div>
            <div class="spacer"></div>
            ${allBadge}
            ${todayMark}
          </div>
          <div class="chips">
            ${eventChips.join("")}
            ${installs.join("")}
          </div>
        </div>
      `;
    }).join("");

    $("calGrid").querySelectorAll(".calCell[data-day]").forEach(el=>{
      el.addEventListener("click", ()=> openDayModal(el.dataset.day));
    });
  }

  function openDayModal(day){
    modalDay = day;
    $("dayModalTitle").textContent = `üìÖ ${day}`;
    $("dayModalBack").style.display="flex";
    renderDayModal();
  }
  function closeDayModal(){
    $("dayModalBack").style.display="none";
    modalDay = null;
  }

  function renderDayModal(){
    if(!modalDay) return;

    const allDay = hasAllDay(modalDay);
    $("dayInstallBlockHint").textContent = allDay ? "‚ö† ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ Full day event ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏° Install ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ" : "";

    const circuits = Object.values(state.circuits).slice().sort((a,b)=>(a.name||"").localeCompare(b.name||""));
    $("dayInstallCircuit").innerHTML = circuits.length
      ? circuits.map(c=>`<option value="${c.id}">${escapeHtml(c.type)} ‚Ä¢ ${escapeHtml(c.cid)} ‚Ä¢ ${escapeHtml(c.name)}${c.installDate?` (‡∏°‡∏µ ${c.installDate})`:``}</option>`).join("")
      : `<option value="">(no circuits)</option>`;

    $("dayAddInstallBtn").disabled = allDay || circuits.length===0;
    $("dayInstallCircuit").disabled = allDay || circuits.length===0;
    $("dayInstallNote").disabled = allDay || circuits.length===0;

    const installs = circuits.filter(c=>c.installDate===modalDay).sort((a,b)=>(a.cid||"").localeCompare(b.cid||""));
    $("dayInstallList").innerHTML = installs.length ? installs.map(c=>{
      return `
        <tr data-cid="${c.id}">
          <td><b>${escapeHtml(c.cid)}</b><div class="muted small">${escapeHtml(c.name)}</div></td>
          <td>${(c.installNote||"").trim()?escapeHtml(c.installNote):"<span class='muted'>-</span>"}</td>
          <td><input type="date" data-f="move" value="${escapeHtml(modalDay)}" ${allDay?"disabled":""} /></td>
          <td>
            <button class="btn" data-act="move" ${allDay?"disabled":""}>Move</button>
            <button class="btn danger" data-act="clear">Clear</button>
          </td>
        </tr>
      `;
    }).join("") : `<tr><td colspan="4" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Install ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>`;

    $("dayInstallList").querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const tr = btn.closest("tr");
        const cid = tr.dataset.cid;
        const act = btn.dataset.act;
        const c = state.circuits[cid];
        if(!c) return;

        if(act==="clear"){
          const prev=c.installDate;
          c.installDate=""; c.installNote="";
          touchUpdate(c);
          addLogCircuit(c,"INSTALL_CLEAR",`‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á (‡πÄ‡∏î‡∏¥‡∏° ${prev})`);
          save(true);
          toast("‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
          renderAll(true); renderDayModal();
          return;
        }

        if(act==="move"){
          const newDate = tr.querySelector('input[data-f="move"]').value;
          if(!newDate){ toast("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
          if(isInstallBlocked(newDate)){ toast("‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô Full day event ‡∏≠‡∏¢‡∏π‡πà ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô"); return; }
          if(newDate!==c.installDate){
            const ok = confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ${c.installDate} ‚Üí ${newDate} ?`);
            if(!ok) return;
          }
          const prev=c.installDate;
          c.installDate=newDate;
          touchUpdate(c);
          addLogCircuit(c,"INSTALL_CHANGE",`‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ${prev} ‚Üí ${newDate}${(c.installNote||"").trim()?` (${c.installNote.trim()})`:``}`);
          save(true);
          toast("‡∏¢‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
          renderAll(true);
          renderDayModal();
        }
      });
    });

    const evs = eventsOn(modalDay).slice().sort((a,b)=>a.slot.localeCompare(b.slot));
    let ruleText = "";
    if(hasAllDay(modalDay)) ruleText = "‡∏°‡∏µ ALL ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πâ‡∏≤/‡∏ö‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ + ‡πÄ‡∏û‡∏¥‡πà‡∏° Install ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
    else if(hasSlot(modalDay,"AM") && hasSlot(modalDay,"PM")) ruleText = "‡∏°‡∏µ‡πÄ‡∏ä‡πâ‡∏≤+‡∏ö‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
    else ruleText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤ (AM/PM ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á)";

    $("dayEventRuleHint").textContent = ruleText;

    $("dayEventList").innerHTML = evs.length ? evs.map(e=>{
      return `
        <tr data-eid="${e.id}">
          <td class="mono">${escapeHtml(e.slot)}</td>
          <td><b>${escapeHtml(e.title)}</b></td>
          <td>${(e.note||"").trim()?escapeHtml(e.note):"<span class='muted'>-</span>"}</td>
          <td><button class="btn danger" data-act="del">Del</button></td>
        </tr>
      `;
    }).join("") : `<tr><td colspan="4" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ event</td></tr>`;

    $("dayEventList").querySelectorAll("button[data-act='del']").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const tr=btn.closest("tr");
        const eid=tr.dataset.eid;
        const idx=state.events.findIndex(e=>e.id===eid);
        if(idx<0) return;
        const ev=state.events[idx];
        state.events.splice(idx,1);
        addLogSystem("EVENT_REMOVE", `${ev.date} ${ev.slot} ${ev.title}`);
        save(true);
        toast("‡∏•‡∏ö event ‡πÅ‡∏•‡πâ‡∏ß");
        renderAll(true); renderDayModal();
      });
    });
  }

  /** ===== startup ===== */
  monthGuardAutoReset();
  setDirty(isDirty());
  renderAll(true);
  switchRightTab("dashboard");
  startAutoSync();
});
</script>
</body>
</html>
